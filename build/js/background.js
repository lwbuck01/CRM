/*
 * Original can be found at https://github.com/SanderRonde/CustomRightClickMenu 
 * This code may only be used under the MIT style license found in the LICENSE.txt file 
**/
"use strict";var Promiselike=function(){function a(a){var b=this;this._listeners=[],this._rejectListeners=[],this._status="pending",a(function(a){"pending"===b._status&&(b._status="fulfilled",b._result=a,b._listeners.forEach(function(b){b(a)}))},function(a){"pending"===b._status&&(b._rejectReason=a,b._status="rejected",b._rejectListeners.forEach(function(b){b(a)}))})}return a.prototype.then=function(a,b){return"fulfilled"===this._status&&a(this._result),this._listeners.push(a),b&&("rejected"===this._status&&b(this._rejectReason),this._rejectListeners.push(b)),this},a.prototype.catch=function(a){return this._rejectListeners.push(a),"rejected"===this._status&&a(this._rejectReason),this},a.all=function(b){var c=!1;return new a(function(a,d){var e=Array.prototype.slice.apply(b).map(function(a){return{done:!1,promise:a}});e.forEach(function(b){b.promise.then(function(d){b.done=!0,b.result=d,c||0===e.filter(function(a){return!a.done}).length&&a(e.map(function(a){return a.result}))},function(a){d(a)})})})},a.race=function(b){return new a(function(a,c){Array.prototype.slice.apply(b).map(function(b){b.then(function(b){a(b)},function(a){c(a)})})})},a}();window.isDev=chrome.runtime.getManifest().short_name.indexOf("dev")>-1,function(globalObject,sandboxes){globalObject.globals={latestId:0,storages:{settingsStorage:null,globalExcludes:null,resourceKeys:null,urlDataPairs:null,storageLocal:null,nodeStorage:null,resources:null},background:{workers:[],byId:{}},crm:{crmTree:[],crmById:{},safeTree:[],crmByIdSafe:{}},keys:{},availablePermissions:[],crmValues:{tabData:{0:{nodes:{},libraries:{}}},rootId:null,contextMenuIds:{},nodeInstances:{},contextMenuInfoById:{},contextMenuItemTree:[],hideNodesOnPagesData:{},stylesheetNodeStatusses:{}},toExecuteNodes:{onUrl:{},always:[]},sendCallbackMessage:function(a,b,c,d){var e={type:d.err?"error":"success",data:d.err?d.errorMessage:d.args,callbackId:d.callbackId,messageType:"callback"};try{globalObject.globals.crmValues.tabData[a].nodes[c][b].port.postMessage(e)}catch(d){if("Converting circular structure to JSON"!==d.message)throw d;e.data="Converting circular structure to JSON, getting a response from this API will not work",e.type="error",globalObject.globals.crmValues.tabData[a].nodes[c][b].port.postMessage(e)}},notificationListeners:{},scriptInstallListeners:{},logging:{filter:{id:null,tabId:null}},constants:{supportedHashes:["sha1","sha256","sha384","sha512","md5"],validSchemes:["http","https","file","ftp","*"],templates:{mergeArrays:function(a,b){for(var c=0;c<b.length;c++)a[c]&&"object"==typeof b[c]&&"object"==typeof a[c]&&void 0!==a[c]&&null!==a[c]?Array.isArray(b[c])?a[c]=this.mergeArrays(a[c],b[c]):a[c]=this.mergeObjects(a[c],b[c]):a[c]=b[c];return a},mergeObjects:function(a,b){for(var c in b)b.hasOwnProperty(c)&&("object"==typeof b[c]&&"object"==typeof a[c]&&void 0!==a[c]&&null!==a[c]?Array.isArray(b[c])?a[c]=this.mergeArrays(a[c],b[c]):a[c]=this.mergeObjects(a[c],b[c]):a[c]=b[c]);return a},getDefaultNodeInfo:function(a){void 0===a&&(a={});var b={permissions:[],installDate:(new Date).toLocaleDateString(),lastUpdatedAt:Date.now(),version:"1.0",isRoot:!1,source:"local"};return this.mergeObjects(b,a)},getDefaultLinkNode:function(a){void 0===a&&(a={});var b={name:"name",onContentTypes:[!0,!0,!0,!1,!1,!1],type:"link",showOnSpecified:!1,nodeInfo:this.getDefaultNodeInfo(a.nodeInfo),triggers:[{url:"*://*.example.com/*",not:!1}],isLocal:!1,value:[{newTab:!0,url:"https://www.example.com"}]};return this.mergeObjects(b,a)},getDefaultStylesheetValue:function(a){void 0===a&&(a={});var b={stylesheet:[].join("\n"),launchMode:0,toggle:!1,defaultOn:!1,options:{},convertedStylesheet:null};return this.mergeObjects(b,a)},getDefaultScriptValue:function(a){void 0===a&&(a={});var b={launchMode:0,backgroundLibraries:[],libraries:[],script:[].join("\n"),backgroundScript:"",metaTags:{},options:{}};return this.mergeObjects(b,a)},getDefaultScriptNode:function(a){void 0===a&&(a={});var b={name:"name",onContentTypes:[!0,!0,!0,!1,!1,!1],type:"script",isLocal:!1,nodeInfo:this.getDefaultNodeInfo(a.nodeInfo),triggers:[{url:"*://*.example.com/*",not:!1}],value:this.getDefaultScriptValue(a.value)};return this.mergeObjects(b,a)},getDefaultStylesheetNode:function(a){void 0===a&&(a={});var b={name:"name",onContentTypes:[!0,!0,!0,!1,!1,!1],type:"stylesheet",isLocal:!0,nodeInfo:this.getDefaultNodeInfo(a.nodeInfo),triggers:[{url:"*://*.example.com/*",not:!1}],value:this.getDefaultStylesheetValue(a.value)};return this.mergeObjects(b,a)},getDefaultDividerOrMenuNode:function(a,b){void 0===a&&(a={});var c={name:"name",type:b,nodeInfo:this.getDefaultNodeInfo(a.nodeInfo),onContentTypes:[!0,!0,!0,!1,!1,!1],isLocal:!0,value:null,showOnSpecified:!0,children:"menu"===b?[]:null,permissions:[]};return this.mergeObjects(c,a)},getDefaultDividerNode:function(a){return void 0===a&&(a={}),this.getDefaultDividerOrMenuNode(a,"divider")},getDefaultMenuNode:function(a){return void 0===a&&(a={}),this.getDefaultDividerOrMenuNode(a,"menu")},globalObjectWrapperCode:function(a,b,c){return"var "+b+" = {};"+("for (var prop in "+a+") {")+"(function(prop) {"+("if (typeof("+a+"[prop]) === 'function')  {")+(b+"[prop] = function() { return "+a+"[prop].apply("+a+", arguments); }")+"}else {"+("Object.defineProperty("+b+", prop, {")+"'get': function() {"+("if ("+a+"[prop] === "+a+") {")+("return "+b+";")+"}else if (prop === 'crmAPI') {return crmAPI}else if (prop === 'crome') {return "+c+"}else {"+("return "+a+"[prop];")+"}},"+("'set': function(value) { "+b+"[prop] = value; }")+"});}})(prop);}"}},specialJSON:{_regexFlagNames:["global","multiline","sticky","unicode","ignoreCase"],_getRegexFlags:function(a){var b=[];return this._regexFlagNames.forEach(function(c){a[c]&&("sticky"===c?b.push("y"):b.push(c[0]))}),b},_stringifyNonObject:function(a){if("function"==typeof a){var b=a.toString(),c=this._fnRegex.exec(b);a="__fn$"+("("+c[2]+"){"+c[10]+"}")+"$fn__"}else a instanceof RegExp?a="__regexp$"+JSON.stringify({regexp:a.source,flags:this._getRegexFlags(a)})+"$regexp__":a instanceof Date?a="__date$"+(a+"")+"$date__":"string"==typeof a&&(a=a.replace(/\$/g,"\\$"));return JSON.stringify(a)},_fnRegex:/^(.|\s)*\(((\w+((\s*),?(\s*)))*)\)(\s*)(=>)?(\s*)\{((.|\n|\r)+)\}$/,_specialStringRegex:/^__(fn|regexp|date)\$((.|\n)+)\$\1__$/,_fnCommRegex:/^\(((\w+((\s*),?(\s*)))*)\)\{((.|\n|\r)+)\}$/,_parseNonObject:function(a){var b=JSON.parse(a);if("string"==typeof b){var c=void 0;if(!(c=this._specialStringRegex.exec(b)))return b.replace(/\\\$/g,"$");var d=c[2];switch(c[1]){case"fn":var e=this._fnCommRegex.exec(d);return""!==e[1].trim()?Function.apply(void 0,e[1].split(",").concat([e[6]])):new Function(e[6]);case"regexp":var f=JSON.parse(d);return new RegExp(f.regexp,f.flags.join(""));case"date":return new Date}}return b},_iterate:function(a,b,c){return Array.isArray(b)?(a=a||[],b.forEach(function(b,d,e){a[d]=c(b,d,e)})):(a=a||{},Object.getOwnPropertyNames(b).forEach(function(d){a[d]=c(b[d],d,b)})),a},_isObject:function(a){return!(a instanceof Date||a instanceof RegExp||a instanceof Function)&&("object"==typeof a&&!Array.isArray(a))},_toJSON:function(a,b,c,d){var e=this;if(this._isObject(b)||Array.isArray(b)){if(d.originalValues.indexOf(b)===-1){var f=d.refs.length;d.refs[f]=a,d.paths[f]=c,d.originalValues[f]=b}a=this._iterate(a,b,function(b,f){if(e._isObject(b)||Array.isArray(b)){var g=void 0;if((g=d.originalValues.indexOf(b))===-1){g=d.refs.length,a=Array.isArray(b)?[]:{},d.refs.push(null),d.paths[g]=c;var h=e._toJSON(a[f],b,c.concat(f),d);d.refs[g]=h.data,d.originalValues[g]=b}return"__$"+g+"$__"}return e._stringifyNonObject(b)});var g=Array.isArray(b);return g?{refs:d.refs,data:a,rootType:"array"}:{refs:d.refs,data:a,rootType:"object"}}return{refs:[],data:this._stringifyNonObject(b),rootType:"normal"}},toJSON:function(a,b){var c=this;void 0===b&&(b=[]);var d=[[]],e=[a];if(this._isObject(a)||Array.isArray(a)){var f=Array.isArray(a)?[]:{};return b.push(f),f=this._iterate(f,a,function(a,g){if(c._isObject(a)||Array.isArray(a)){var h=void 0;if((h=e.indexOf(a))===-1){h=b.length,b.push(null);var i=c._toJSON(f[g],a,[g],{refs:b,paths:d,originalValues:e}).data;e[h]=a,d[h]=[g],b[h]=i}return"__$"+h+"$__"}return c._stringifyNonObject(a)}),JSON.stringify({refs:b,data:f,rootType:Array.isArray(a)?"array":"object",paths:d})}return JSON.stringify({refs:[],data:this._stringifyNonObject(a),rootType:"normal",paths:[]})},_refRegex:/^__\$(\d+)\$__$/,_replaceRefs:function(a,b){var c=this;return this._iterate(a,a,function(a){var d;if(d=c._refRegex.exec(a)){var e=d[1],f=b[~~e];return f.parsed?f.ref:(f.parsed=!0,c._replaceRefs(f.ref,b))}return c._parseNonObject(a)}),a},fromJSON:function(a){var b=JSON.parse(a);b.refs=b.refs.map(function(a){return{ref:a,parsed:!1}});var c=b.refs;return"normal"===b.rootType?JSON.parse(b.data):(c[0].parsed=!0,this._replaceRefs(c[0].ref,c))}},contexts:["page","link","selection","image","video","audio"],permissions:["alarms","activeTab","background","bookmarks","browsingData","clipboardRead","clipboardWrite","contentSettings","cookies","contentSettings","contextMenus","declarativeContent","desktopCapture","downloads","history","identity","idle","management","notifications","pageCapture","power","printerProvider","privacy","sessions","system.cpu","system.memory","system.storage","tabs","topSites","tabCapture","tts","webNavigation","webRequest","webRequestBlocking"],tamperMonkeyExtensions:["gcalenpjmijncebpfijmoaglllgpjagf","dhdgffkkebhmkfjojejmpbldmpobfkfo"]},listeners:{idVals:[],tabVals:[],ids:[],tabs:[],log:[]}},window.logging=globalObject.globals.logging;var Helpers=function(){function a(){}return a.compareArray=function(a,b){if(!a&&!b)return!1;if(!a||!b)return!0;var c=a.length;if(c!==b.length)return!1;for(var d=0;d<c;d++)if("object"==typeof a[d]){if("object"!=typeof b[d])return!1;if(Array.isArray(a[d])){if(!Array.isArray(b[d]))return!1;if(!this.compareArray(a[d],b[d]))return!1}else if(!this._compareObj(a[d],b[d]))return!1}else if(a[d]!==b[d])return!1;return!0},a.safe=function(a){return globalObject.globals.crm.crmByIdSafe[a.id]},a.createSecretKey=function(){for(var a=[],b=0;b<25;b++)a[b]=Math.round(100*Math.random());return globalObject.globals.keys[a.join(",")]?this.createSecretKey():(globalObject.globals.keys[a.join(",")]=!0,a)},a.generateItemId=function(){return globalObject.globals.latestId=globalObject.globals.latestId||0,globalObject.globals.latestId++,globalObject.globals.storages.settingsStorage&&Storages.applyChanges({type:"optionsPage",settingsChanges:[{key:"latestId",oldValue:globalObject.globals.latestId-1,newValue:globalObject.globals.latestId}]}),globalObject.globals.latestId},a.convertFileToDataURI=function(a,b,c){var d=new window.XMLHttpRequest;d.responseType="blob",d.onload=function(){var a=[null,null],c=new FileReader;c.onloadend=function(){a[0]=c.result,a[1]&&b(a[0],a[1])},c.readAsDataURL(d.response);var e=new FileReader;e.onloadend=function(){a[1]=e.result,a[0]&&b(a[0],a[1])},e.readAsText(d.response)},c&&(d.onerror=c),d.open("GET",a),d.send()},a.isNewer=function(a,b){for(var c=a.split("."),d=b.split("."),e=c.length>d.length?c.length:d.length,f=0;f<e;f++){var g=~~c[f],h=~~d[f];if(g>h)return!0;if(g<h)return!1}return!1},a.pushIntoArray=function(a,b,c){if(b===c.length)c[b]=a;else for(var d=c.length+1,e=c[b],f=a,g=b;g<d;g++)c[g]=f,f=e,e=c[g+1];return c},a.flattenCrm=function(a,b){var c=this;a.push(b),"menu"===b.type&&b.children&&b.children.forEach(function(b){c.flattenCrm(a,b)})},a.checkForChromeErrors=function(a){chrome.runtime.lastError&&a&&console.log("chrome runtime error",chrome.runtime.lastError)},a.removeTab=function(a){var b=globalObject.globals.crmValues.stylesheetNodeStatusses;for(var c in b)b.hasOwnProperty(c)&&b[c][a]&&delete b[c][a];delete globalObject.globals.crmValues.tabData[a]},a.leftPad=function(a,b){for(var c="",d=0;d<b;d++)c+=a;return c},a.getLastItem=function(a){return a[a.length-1]},a.endsWith=function(a,b){return 0===a.split("").reverse().join("").indexOf(b.split("").reverse().join(""))},a.isTamperMonkeyEnabled=function(a){chrome.management.getAll(function(b){var c=b.filter(function(a){return globalObject.globals.constants.tamperMonkeyExtensions.indexOf(a.id)>-1&&a.enabled});a(c.length>0)})},a._compareObj=function(a,b){for(var c in a)if(a.hasOwnProperty(c)&&void 0!==a[c])if("object"==typeof a[c]){if("object"!=typeof b[c])return!1;if(Array.isArray(a[c])){if(!Array.isArray(b[c]))return!1;if(!this.compareArray(a[c],b[c]))return!1}else if(!this._compareObj(a[c],b[c]))return!1}else if(a[c]!==b[c])return!1;return!0},a}();Helpers.jsonFn={stringify:function(a){return JSON.stringify(a,function(a,b){return b instanceof Function||"function"==typeof b?b.toString():b instanceof RegExp?"_PxEgEr_"+b:b})},parse:function(str,date2Obj){var iso8061=!!date2Obj&&/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/;return JSON.parse(str,function(key,value){if("string"!=typeof value)return value;if(value.length<8)return value;var prefix=value.substring(0,8);return iso8061&&value.match(iso8061)?new Date(value):"function"===prefix?eval("("+value+")"):"_PxEgEr_"===prefix?eval(value.slice(8)):value})}};var GlobalDeclarations=function(){function a(){}return a.initGlobalFunctions=function(){function a(a){return a.sort(function(a,b){return new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime()})}function b(a,b){if(""===b)return a;var c=new RegExp(b);return a.filter(function(a){for(var b=0;b<a.data.length;b++)if("function"!=typeof a.data[b]&&"object"!=typeof a.data[b]&&c.test(String(a.data[b])))return!0;return!1})}function c(c,d,e){var f=[];if("all"===c)for(var g in globalObject.globals.logging)globalObject.globals.logging.hasOwnProperty(g)&&"filter"!==g&&(f=f.concat(globalObject.globals.logging[g].logMessages));else f=globalObject.globals.logging[c].logMessages||[];return a("all"===d?b(f,e):b(f.filter(function(a){return a.tabId===d}),e))}function d(a,b,d){return"ALL"===a||0===a?this.id="all":this.id=a,"ALL"===b||0===b?this.tab="all":"string"==typeof b&&"background"===b.toLowerCase()?this.tab=0:this.tab=b,d?this.text=d:this.text="",c(this.id,this.tab,this.text)}function e(a,b,c){if(!a[0].finished){for(var d=0;d<a.length;d++)if(a[d].done===!1)return;a[0].finished=!0;var e=a.map(function(a){return a.result}).filter(function(a){return!!a});c(JSON.stringify(e)===JSON.stringify(b)?b:e)}}window.getID=function(a){a=a.toLocaleLowerCase();var b=[];for(var c in globalObject.globals.crm.crmById)if(globalObject.globals.crm.crmById.hasOwnProperty(c)){var d=globalObject.globals.crm.crmById[c],e=d.name;"script"===d.type&&"string"==typeof e&&a===e.toLocaleLowerCase()&&b.push({id:c,node:d})}0===b.length?console.log("Unfortunately no matches were found, please try again"):1===b.length?console.log("One match was found, the id is ",b[0].id," and the script is ",b[0].node):(console.log("Found multiple matches, here they are:"),b.forEach(function(a){console.log("Id is",a.id,", script is",a.node)}))},window.filter=function(a,b){globalObject.globals.logging.filter={id:~~a,tabId:void 0!==b?~~b:null}},window._listenIds=function(a){a(Logging.Listeners.updateTabAndIdLists(!0).ids),globalObject.globals.listeners.ids.push(a)},window._listenTabs=function(a){a(Logging.Listeners.updateTabAndIdLists(!0).tabs),globalObject.globals.listeners.tabs.push(a)},window._listenLog=function(a,b){var e={id:"all",tab:"all",text:"",listener:a,update:function(a,b,c){return d.apply(e,[a,b,c])},index:globalObject.globals.listeners.log.length};return b(e),globalObject.globals.listeners.log.push(e),c("all","all","")},window._getIdCurrentTabs=function(a,b,c){var d=[],f=globalObject.globals.crmValues.tabData,g=function(g){if(f.hasOwnProperty(g)&&(f[g].nodes[a]||0===a))if("0"===g)d.push({done:!0,result:{id:"background",title:"background"}});else{var h=d.length;d.push({done:!1}),chrome.tabs.get(~~g,function(a){return chrome.runtime.lastError?void Helpers.removeTab(~~g):(d[h].done=!0,d[h].result={id:~~g,title:a.title},void e(d,b,c))})}};for(var h in f)g(h);e(d,b,c)},window._getCurrentTabIndex=function(a,b,c){c("background"===b.id?[0]:globalObject.globals.crmValues.tabData[b.id].nodes[a].map(function(a,b){return b}))}},a.permissionsChanged=function(a){globalObject.globals.availablePermissions=a.permissions},a.refreshPermissions=function(){chrome.permissions.onRemoved.addListener(this.permissionsChanged),chrome.permissions.onAdded.addListener(this.permissionsChanged),chrome.permissions.getAll(this.permissionsChanged)},a.setHandlerFunction=function(){window.createHandlerFunction=function(a){return function(b){var c=globalObject.globals.crmValues,d=c.tabData,e=c.nodeInstances,f=Helpers.getLastItem(d[b.tabId].nodes[b.id]);if(f.port)MessageHandling.handleCrmAPIMessage(b);else if(Helpers.compareArray(f.secretKey,b.key)){delete f.secretKey,f.port=a,e[b.id]||(e[b.id]={});var g=[],h=function(a){if(e[b.id].hasOwnProperty(a)&&e[b.id][a])try{d[a].nodes[b.id].forEach(function(c,d,e){~~a===b.tabId&&d===e.length-1||(g.push({id:~~a,tabIndex:d}),c.port.postMessage({change:{type:"added",value:~~b.tabId,tabIndex:d},messageType:"instancesUpdate"}))})}catch(c){delete e[b.id][a]}};for(var i in e[b.id])h(i);e[b.id][b.tabId]=e[b.id][b.tabId]||[],e[b.id][b.tabId].push({hasHandler:!1}),a.postMessage({data:"connected",instances:g})}}}},a.init=function(){function a(a){chrome.contextMenus.remove(a.id,function(){Helpers.checkForChromeErrors(!1)})}function b(a,c){for(var d=0;d<a.length;d++)a[d].enabled=c,a[d].children&&b(a[d].children,c)}function c(a,b){for(var c=0;c<a.length;c++)if(a[c]&&b[a[c].id])return c;return 1/0}function d(a,b,c){var d=b.id;b.enabled=!0;var f=globalObject.globals.crmValues.contextMenuInfoById[b.id].settings;"stylesheet"===b.node.type&&b.node.value.toggle&&(f.checked=b.node.value.defaultOn),f.parentId=a,delete f.generatedId;var g=chrome.contextMenus.create(f);b.id=g,globalObject.globals.crmValues.contextMenuIds[b.node.id]=g,globalObject.globals.crmValues.contextMenuInfoById[g]=globalObject.globals.crmValues.contextMenuInfoById[d],globalObject.globals.crmValues.contextMenuInfoById[d]=void 0,globalObject.globals.crmValues.contextMenuInfoById[g].enabled=!0,b.children&&e(g,b.children,c)}function e(a,b,c){for(var e=0;e<b.length;e++)c[b[e].id]&&"show"===c[b[e].id].type||!c[b[e].id]?d(a,b[e],c):globalObject.globals.crmValues.contextMenuInfoById[b[e].id].enabled=!1}function f(e,g,h){var i=c(g,h);if(i<g.length)for(var j=0;j<i;j++)g[j].children&&g[j].children.length>0&&f(g[j].id,g[j].children,h);for(var j=i;j<g.length;j++)if(h[g[j].id])if("hide"===h[g[j].id].type)a(g[j]),g[j].enabled=!1,g[j].children&&b(g[j].children,!1);else{for(var k=[g[j]],l=j+1;l<g.length;l++)h[g[l].id]?"hide"===h[g[l].id].type?(a(g[l]),globalObject.globals.crmValues.contextMenuItemTree[g[l].id].enabled=!1):k.push(g[l]):g[l].enabled&&(k.push(g[l]),a(g[l]));for(var l=0;l<k.length;l++)d(e,k[l],h)}}function g(a,b,c){for(var d=0;d<a.length;d++)a[d]&&((a[d].enabled?c:b).push(a[d]),g(a[d].children,b,c))}function h(a){function b(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError)}var c=a.tabIds[a.tabIds.length-1];chrome.tabs.get(c,function(a){if(chrome.runtime.lastError)return void console.log(chrome.runtime.lastError.message);var b=[],c=[],d={},e=[],h=[];g(globalObject.globals.crmValues.contextMenuItemTree,h,e);for(var i,j=0;j<h.length;j++)i=globalObject.globals.crmValues.hideNodesOnPagesData[h[j].node.id],i&&URLParsing.matchesUrlSchemes(i,a.url)||c.push({node:h[j].node,id:h[j].id});for(var j=0;j<e.length;j++)i=globalObject.globals.crmValues.hideNodesOnPagesData[e[j].node.id],i&&URLParsing.matchesUrlSchemes(i,a.url)&&b.push({node:e[j].node,id:e[j].id});for(var k=c.length,j=0;j<k;j++)i=globalObject.globals.crmValues.hideNodesOnPagesData[c[j].node.id],i&&URLParsing.matchesUrlSchemes(i,a.url)&&(c.splice(j,1),k--,j--);for(var j=0;j<b.length;j++)d[b[j].id]={node:b[j].node,type:"hide"};for(var j=0;j<c.length;j++)d[c[j].id]={node:c[j].node,type:"show"};f(globalObject.globals.crmValues.rootId,globalObject.globals.crmValues.contextMenuItemTree,d)});var d=globalObject.globals.crmValues.stylesheetNodeStatusses;for(var e in d)d.hasOwnProperty(e)&&d[e]&&chrome.contextMenus.update(globalObject.globals.crmValues.contextMenuIds[e],{checked:"boolean"!=typeof d[e][c]?d[e].defaultValue:d[e][c]},b)}function i(){chrome.tabs.onRemoved.addListener(function(a){for(var b in globalObject.globals.crmValues.stylesheetNodeStatusses)globalObject.globals.crmValues.stylesheetNodeStatusses.hasOwnProperty(b)&&globalObject.globals.crmValues.stylesheetNodeStatusses[b]&&(globalObject.globals.crmValues.stylesheetNodeStatusses[b][a]=void 0);var c=[];for(var b in globalObject.globals.crmValues.nodeInstances)globalObject.globals.crmValues.nodeInstances.hasOwnProperty(b)&&globalObject.globals.crmValues.nodeInstances[b]&&globalObject.globals.crmValues.nodeInstances[b][a]&&(c.push(b),globalObject.globals.crmValues.nodeInstances[b][a]=void 0);for(var d=0;d<c.length;d++)c[d].node&&void 0!==c[d].node.id&&globalObject.globals.crmValues.tabData[a].nodes[c[d].node.id].forEach(function(b){b.port.postMessage({change:{type:"removed",value:a},messageType:"instancesUpdate"})});delete globalObject.globals.crmValues.tabData[a],Logging.Listeners.updateTabAndIdLists()})}function j(){chrome.notifications&&(chrome.notifications.onClicked.addListener(function(a){var b=globalObject.globals.notificationListeners[a];b&&void 0!==b.onClick&&globalObject.globals.sendCallbackMessage(b.tabId,b.tabIndex,b.id,{err:!1,args:[a],callbackId:b.onClick})}),chrome.notifications.onClosed.addListener(function(a,b){var c=globalObject.globals.notificationListeners[a];c&&void 0!==c.onDone&&globalObject.globals.sendCallbackMessage(c.tabId,c.tabIndex,c.id,{err:!1,args:[a,b],callbackId:c.onClick}),delete globalObject.globals.notificationListeners[a]}))}function k(){Helpers.isTamperMonkeyEnabled(function(a){globalObject.globals.storages.storageLocal.useAsUserscriptInstaller=!a,chrome.storage.local.set({useAsUserscriptInstaller:!a})})}function l(){k(),chrome.management.onInstalled.addListener(k),chrome.management.onEnabled.addListener(k),chrome.management.onUninstalled.addListener(k),chrome.management.onDisabled.addListener(k)}var m=this;chrome.tabs.onHighlighted.addListener(h),chrome.webRequest.onBeforeRequest.addListener(function(a){var b=a.url.split("chrome-extension://"+chrome.runtime.id+"/resource/")[1].split("/"),c=b[0],d=~~b[1];return{redirectUrl:m.getResourceData(c,d)}},{urls:["chrome-extension://"+chrome.runtime.id+"/resource/*"]},["blocking"]),i(),j(),l()},a.getResourceData=function(a,b){return globalObject.globals.storages.resources[b][a]&&globalObject.globals.storages.resources[b][a].matchesHashes?globalObject.globals.storages.urlDataPairs[globalObject.globals.storages.resources[b][a].sourceUrl].dataURI:null},a}(),Logging=function(){function a(){}return a.log=function(a,b){for(var c=[],d=2;d<arguments.length;d++)c[d-2]=arguments[d];null!==globalObject.globals.logging.filter.id?a===globalObject.globals.logging.filter.id&&(null!==globalObject.globals.logging.filter.tabId?"*"!==b&&b!==globalObject.globals.logging.filter.tabId||console.log.apply(console,c):console.log.apply(console,c)):console.log.apply(console,c)},a.backgroundPageLog=function(b,c){for(var d=[],e=2;e<arguments.length;e++)d[e-2]=arguments[e];c=c||[void 0,void 0];var f={tabId:"background",nodeTitle:globalObject.globals.crm.crmById[b].name,tabTitle:"Background Page",value:d,lineNumber:c[0],logId:c[1],timestamp:(new Date).toLocaleString()},g={id:b},h=["Background page [",g,"]: "].concat(d);a.log.bind(globalObject,b,"background").apply(globalObject,h);for(var i in f)f.hasOwnProperty(i)&&(g[i]=f[i]);globalObject.globals.logging[b]=globalObject.globals.logging[b]||{logMessages:[]},globalObject.globals.logging[b].logMessages.push(g),a._updateLogs(g)},a.logHandler=function(a){switch(this._prepareLog(a.id,a.tabId),a.type){case"evalResult":chrome.tabs.get(a.tabId,function(b){globalObject.globals.listeners.log[a.callbackIndex].listener({id:a.id,tabId:a.tabId,tabIndex:a.tabIndex,nodeTitle:globalObject.globals.crm.crmById[a.id].name,tabTitle:b.title,type:"evalResult",lineNumber:a.lineNumber,timestamp:a.timestamp,val:"success"===a.value.type?{type:"success",result:globalObject.globals.constants.specialJSON.fromJSON(a.value.result)}:a.value})});break;case"log":default:this._logHandlerLog({type:a.type,id:a.id,data:a.data,tabIndex:a.tabIndex,lineNumber:a.lineNumber,tabId:a.tabId,logId:a.logId,callbackIndex:a.callbackIndex,timestamp:a.type})}},a._prepareLog=function(a,b){if(globalObject.globals.logging[a])globalObject.globals.logging[a][b]||(globalObject.globals.logging[a][b]={});else{var c={values:[],logMessages:[]};c[b]={},globalObject.globals.logging[a]=c}},a._updateLogs=function(a){globalObject.globals.listeners.log.forEach(function(b){var c="all"===b.id||~~b.id===~~a.id,d="all"===b.tab||"background"===b.tab&&b.tab===a.tabId||"background"!==b.tab&&~~b.tab===~~a.tabId;c&&d&&b.listener(a)})},a._logHandlerLog=function(a){var b=this,c={},d=["Log[src:",c,"]: "],e={id:a.id,tabId:a.tabId,logId:a.logId,tabIndex:a.tabIndex,lineNumber:a.lineNumber||"?",timestamp:(new Date).toLocaleString()};chrome.tabs.get(a.tabId,function(f){var g=globalObject.globals.constants.specialJSON.fromJSON(a.data);d=d.concat(g),b.log.bind(globalObject,a.id,a.tabId).apply(globalObject,d),c.id=a.id,c.tabId=a.tabId,c.tab=f,c.url=f.url,c.tabIndex=a.tabIndex,c.tabTitle=f.title,c.node=globalObject.globals.crm.crmById[a.id],c.nodeName=c.node.name,e.tabTitle=f.title,e.nodeTitle=c.nodeName,e.data=g,globalObject.globals.logging[a.id].logMessages.push(e),b._updateLogs(e)})},a}();Logging.LogExecution=(_a=function(){function a(){}return a.executeCRMCode=function(a,b){globalObject.globals.crmValues.tabData[a.tab]&&globalObject.globals.crmValues.tabData[a.tab].nodes[a.id][a.tabIndex].port.postMessage({messageType:b,code:a.code,logCallbackIndex:a.logListener.index})},a.displayHints=function(a){globalObject.globals.listeners.log[a.data.callbackIndex].listener({id:a.id,tabId:a.tabId,tabIndex:a.tabIndex,type:"hints",suggestions:a.data.hints})},a}(),_a.parent=Logging,_a),Logging.Listeners=(_b=function(){function a(){}return a.updateTabAndIdLists=function(a){var b=globalObject.globals.listeners;if(!a&&0===b.ids.length&&0===b.tabs.length)return{ids:[],tabs:[]};var c={},d={},e=globalObject.globals.crmValues.tabData;for(var f in e)if(e.hasOwnProperty(f)){"0"===f?d.background=!0:d[f]=!0;var g=e[f].nodes;for(var h in g)g.hasOwnProperty(h)&&(c[h]=!0)}var i=[];for(var j in c)c.hasOwnProperty(j)&&i.push(j);var k=[];for(var f in d)d.hasOwnProperty(f)&&k.push(f);i=i.sort(function(a,b){return a-b}),k=k.sort(function(a,b){return a-b});var l=i.map(function(a){return{id:a,title:globalObject.globals.crm.crmById[a].name}});return Helpers.compareArray(i,b.idVals)||(b.ids.forEach(function(a){a(l)}),b.idVals=i),Helpers.compareArray(k,b.tabVals)||(b.tabs.forEach(function(a){a(k)}),b.tabVals=k),{ids:l,tabs:k}},a}(),_b.parent=Logging,_b),window.backgroundPageLog=Logging.backgroundPageLog;var CRMFunctions=function(){function a(){}return a.getTree=function(a){a.checkPermissions(["crmGet"],function(){a.respondSuccess(globalObject.globals.crm.safeTree)})},a.getSubTree=function(a){a.checkPermissions(["crmGet"],function(){var b=a.message.data.nodeId;if("number"==typeof b){var c=globalObject.globals.crm.crmByIdSafe[b];c?a.respondSuccess([c]):a.respondError("There is no node with id "+b)}else a.respondError("No nodeId supplied")})},a.getNode=function(a){a.checkPermissions(["crmGet"],function(){var b=a.message.data.nodeId;if("number"==typeof b){var c=globalObject.globals.crm.crmByIdSafe[b];c?a.respondSuccess(c):a.respondError("There is no node with id "+b)}else a.respondError("No nodeId supplied")})},a.getNodeIdFromPath=function(a){a.checkPermissions(["crmGet"],function(){var b=a.message.data.path,c=a.lookup(b,globalObject.globals.crm.safeTree,!1);if(c===!0)return!1;if(c===!1)return a.respondError("Path does not return a valid value"),!1;var d=c;return a.respondSuccess(d.id),d.id})},a.queryCrm=function(a){a.checkPermissions(["crmGet"],function(){a.typeCheck([{val:"query",type:"object"},{val:"query.type",type:"string",optional:!0},{val:"query.inSubTree",type:"number",optional:!0},{val:"query.name",type:"string",optional:!0}],function(b){var c=a.message.data.query,d=[];for(var e in globalObject.globals.crm.crmById)globalObject.globals.crm.crmById.hasOwnProperty(e)&&d.push(globalObject.globals.crm.crmByIdSafe[e]);var f=null;if(b["query.inSubTree"]){var g=a.getNodeFromId(c.inSubTree,!0,!0),h=[];if(g){var i=g;h=i.children}f=[],h.forEach(function(a){Helpers.flattenCrm(f,a)})}f=f||d;var j=f;b["query.type"]&&(j=j.filter(function(a){return a.type===c.type})),b["query.name"]&&(j=j.filter(function(a){return a.name===c.name})),j=j.filter(function(a){return null!==a}),a.respondSuccess(j)})})},a.getParentNode=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=JSON.parse(JSON.stringify(b.path));if(c.pop(),0===c.length)a.respondSuccess(globalObject.globals.crm.safeTree);else{var d=a.lookup(c,globalObject.globals.crm.safeTree,!1);a.respondSuccess(d)}})})},a.getNodeType=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){a.respondSuccess(b.type)})})},a.getNodeValue=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){a.respondSuccess(b.value)})})},a.createNode=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"options",type:"object"},{val:"options.usesTriggers",type:"boolean",optional:!0},{val:"options.triggers",type:"array",forChildren:[{val:"url",type:"string"}],optional:!0},{val:"options.linkData",type:"array",forChildren:[{val:"url",type:"string"},{val:"newTab",type:"boolean",optional:!0}],optional:!0},{val:"options.scriptData",type:"object",optional:!0},{dependency:"options.scriptData",val:"options.scriptData.script",type:"string"},{dependency:"options.scriptData",val:"options.scriptData.launchMode",type:"number",optional:!0,min:0,max:3},{dependency:"options.scriptData",val:"options.scriptData.triggers",type:"array",optional:!0,forChildren:[{val:"url",type:"string"}]},{dependency:"options.scriptData",val:"options.scriptData.libraries",type:"array",optional:!0,forChildren:[{val:"name",type:"string"}]},{val:"options.stylesheetData",type:"object",optional:!0},{dependency:"options.stylesheetData",val:"options.stylesheetData.launchMode",type:"number",min:0,max:3,optional:!0},{dependency:"options.stylesheetData",val:"options.stylesheetData.triggers",type:"array",forChildren:[{val:"url",type:"string"}],optional:!0},{dependency:"options.stylesheetData",val:"options.stylesheetData.toggle",type:"boolean",optional:!0},{dependency:"options.stylesheetData",val:"options.stylesheetData.defaultOn",type:"boolean",optional:!0},{val:"options.value",type:"object",optional:!0}],function(){var b=Helpers.generateItemId(),c=a.message.data.options;c=CRM.makeSafe(c),c.id=b,c.nodeInfo=a.getNodeFromId(a.message.id,!1,!0).nodeInfo,a.getNodeFromId(a.message.id,!1,!0).isLocal&&(c.isLocal=!0);var d;switch(a.message.data.options.type){case"script":d=globalObject.globals.constants.templates.getDefaultScriptNode(c),d.type="script";break;case"stylesheet":d=globalObject.globals.constants.templates.getDefaultStylesheetNode(c),d.type="stylesheet";break;case"menu":d=globalObject.globals.constants.templates.getDefaultMenuNode(c),d.type="menu";break;case"divider":d=globalObject.globals.constants.templates.getDefaultDividerNode(c),d.type="divider";break;default:case"link":d=globalObject.globals.constants.templates.getDefaultLinkNode(c),d.type="link"}return(d=a.moveNode(d,a.message.data.options.position))?(CRM.updateCrm([d.id]),a.respondSuccess(a.getNodeFromId(d.id,!0,!0))):a.respondError("Failed to place node"),!0})})},a.copyNode=function(a){return a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"options",type:"object"},{val:"options.name",type:"string",
optional:!0}],function(b){return a.getNodeFromId(a.message.data.nodeId,!0).run(function(c){var d=JSON.parse(JSON.stringify(c));return d.id=Helpers.generateItemId(),a.getNodeFromId(a.message.id,!1,!0).local===!0&&c.isLocal===!0&&(d.isLocal=!0),d.nodeInfo=a.getNodeFromId(a.message.id,!1,!0).nodeInfo,delete d.storage,delete d.file,b["options.name"]&&(d.name=a.message.data.options.name),(d=a.moveNode(d,a.message.data.options.position))&&(CRM.updateCrm([d.id]),a.respondSuccess(a.getNodeFromId(d.id,!0,!0))),!0}),!0})}),!0},a.moveNode=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.lookup(b.path,globalObject.globals.crm.crmTree,!0);(b=a.moveNode(b,a.message.data.position,{children:c,index:b.path[b.path.length-1]}))&&(CRM.updateCrm(),a.respondSuccess(a.getNodeFromId(b.id,!0,!0)))})})},a.deleteNode=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.lookup(b.path,globalObject.globals.crm.crmTree,!0);c.splice(b.path[b.path.length-1],1),void 0!==globalObject.globals.crmValues.contextMenuIds[b.id]?chrome.contextMenus.remove(globalObject.globals.crmValues.contextMenuIds[b.id],function(){CRM.updateCrm([a.message.data.nodeId]),a.respondSuccess(!0)}):(CRM.updateCrm([a.message.data.nodeId]),a.respondSuccess(!0))})})},a.editNode=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"options",type:"object"},{val:"options.name",type:"string",optional:!0},{val:"options.type",type:"string",optional:!0}],function(b){a.getNodeFromId(a.message.data.nodeId).run(function(c){var d=a.message.data;if(b["options.type"]){if("link"!==a.message.data.options.type&&"script"!==a.message.data.options.type&&"stylesheet"!==a.message.data.options.type&&"menu"!==a.message.data.options.type&&"divider"!==a.message.data.options.type)return a.respondError("Given type is not a possible type to switch to, use either script, stylesheet, link, menu or divider"),!1;var e=c.type.toLowerCase();c.type=a.message.data.options.type,"menu"===e?(c.menuVal=c.children,c.value=c[d.options.type+"Val"]||{}):(c[e+"Val"]=c.value,c.value=c[d.options.type+"Val"]||{}),"menu"===c.type&&(c.children=c.value||[],c.value=null)}return b["options.name"]&&(c.name=a.message.data.options.name),CRM.updateCrm([a.message.id]),a.respondSuccess(Helpers.safe(c)),!0})})})},a.getTriggers=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){a.respondSuccess(b.triggers)})})},a.setTriggers=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"triggers",type:"array",forChildren:[{val:"url",type:"string"}]}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.message.data,d=c.triggers;b.showOnSpecified=!0,CRM.updateCrm();var e=[];if(globalObject.globals.crmValues.hideNodesOnPagesData[b.id]=[],"script"!==b.type&&"stylesheet"!==b.type||2!==b.value.launchMode)for(var f=("script"===b.type||"stylesheet"===b.type)&&2===b.value.launchMode,g=0;g<d.length;g++){if(!URLParsing.triggerMatchesScheme(d[g].url))return void a.respondError("Triggers don't match URL scheme");d[g].url=URLParsing.prepareTrigger(d[g].url),f&&(d[g].not?globalObject.globals.crmValues.hideNodesOnPagesData[b.id].push({not:!1,url:d[g].url}):e.push(d[g].url))}else for(var g=0;g<d.length;g++){var h=URLParsing.validatePatternUrl(d[g].url);if(!h)return void a.respondSuccess("Triggers don't match URL scheme")}b.triggers=d,0===e.length&&(e[0]="<all_urls>"),globalObject.globals.crmValues.contextMenuIds[b.id]?chrome.contextMenus.update(globalObject.globals.crmValues.contextMenuIds[b.id],{documentUrlPatterns:e},function(){CRM.updateCrm(),a.respondSuccess(Helpers.safe(b))}):(CRM.updateCrm(),a.respondSuccess(Helpers.safe(b)))})})})},a.getTriggerUsage=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){"menu"===b.type||"link"===b.type||"divider"===b.type?a.respondSuccess(b.showOnSpecified):a.respondError("Node is not of right type, can only be menu, link or divider")})})},a.setTriggerUsage=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"useTriggers",type:"boolean"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){"menu"===c.type||"link"===c.type||"divider"===c.type?(c.showOnSpecified=b.useTriggers,CRM.updateCrm(),globalObject.globals.crmValues.contextMenuIds[c.id]?chrome.contextMenus.update(globalObject.globals.crmValues.contextMenuIds[c.id],{documentUrlPatterns:["<all_urls>"]},function(){CRM.updateCrm(),a.respondSuccess(Helpers.safe(c))}):(CRM.updateCrm(),a.respondSuccess(Helpers.safe(c)))):a.respondError("Node is not of right type, can only be menu, link or divider")})})})},a.getContentTypes=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){a.respondSuccess(b.onContentTypes)})})},a.setContentType=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"index",type:"number",min:0,max:5},{val:"value",type:"boolean"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){c.onContentTypes[b.index]=b.value,CRM.updateCrm(),chrome.contextMenus.update(globalObject.globals.crmValues.contextMenuIds[c.id],{contexts:CRM.getContexts(c.onContentTypes)},function(){CRM.updateCrm(),a.respondSuccess(c.onContentTypes)})})})})},a.setContentTypes=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"contentTypes",type:"array"}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){for(var c=a.message.data,d=0;d<c.contentTypes.length;d++)if("string"!=typeof c.contentTypes[d])return a.respondError("Not all values in array contentTypes are of type string"),!1;for(var e,f=0,g=[],h=["page","link","selection","image","video","audio"],d=0;d<c.contentTypes.length;d++)e=c.contentTypes.indexOf(h[d])>-1,e&&f++,g[d]=e;return f||(g=[!0,!0,!0,!0,!0,!0]),b.onContentTypes=g,chrome.contextMenus.update(globalObject.globals.crmValues.contextMenuIds[b.id],{contexts:CRM.getContexts(b.onContentTypes)},function(){CRM.updateCrm(),a.respondSuccess(Helpers.safe(b))}),!0})})})},a.linkGetLinks=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){return"link"===b.type?a.respondSuccess(b.value):a.respondSuccess(b.linkVal),!0})})},a.linkSetLinks=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"items",type:["object","array"],forChildren:[{val:"newTab",type:"boolean",optional:!0},{val:"url",type:"string"}]}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.message.data,d=c.items;if(Array.isArray(d)){"link"!==b.type&&(b.linkVal=b.linkVal||[]),b.value=[];for(var e=0;e<d.length;e++)d[e].newTab=!!d[e].newTab,"link"===b.type?b.value.push(d[e]):(b.linkVal=b.linkVal||[],b.linkVal.push(d[e]))}else{if(d.newTab=!!d.newTab,!d.url)return a.respondError("For not all values in the array items is the property url defined"),!1;"link"===b.type?b.value=[d]:b.linkVal=[d]}return CRM.updateCrm(),"link"===b.type?a.respondSuccess(Helpers.safe(b).value):a.respondSuccess(Helpers.safe(b).linkVal),!0})})})},a.linkPush=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"items",type:["object","array"],forChildren:[{val:"newTab",type:"boolean",optional:!0},{val:"url",type:"string"}]}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.message.data,d=c.items;if(Array.isArray(d)){"link"!==b.type&&(b.linkVal=b.linkVal||[]);for(var e=0;e<d.length;e++)d[e].newTab=!!d[e].newTab,"link"===b.type?b.value.push(d[e]):(b.linkVal=b.linkVal||[],b.linkVal.push(d[e]))}else{if(d.newTab=!!d.newTab,!d.url)return a.respondError("For not all values in the array items is the property url defined"),!1;"link"===b.type?b.value.push(d):(b.linkVal=b.linkVal||[],b.linkVal.push(d))}return CRM.updateCrm(),"link"===b.type?a.respondSuccess(Helpers.safe(b).value):a.respondSuccess(Helpers.safe(b).linkVal),!0})})})},a.linkSplice=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){a.typeCheck([{val:"start",type:"number"},{val:"amount",type:"number"}],function(){var c,d=a.message.data;"link"===b.type?(c=b.value.splice(d.start,d.amount),CRM.updateCrm(),a.respondSuccess(c,Helpers.safe(b).value)):(b.linkVal=b.linkVal||[],c=b.linkVal.splice(d.start,d.amount),CRM.updateCrm(),a.respondSuccess(c,Helpers.safe(b).linkVal))})})})},a.setLaunchMode=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"launchMode",type:"number",min:0,max:4}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.message.data;return"script"!==b.type&&"stylesheet"!==b.type?(a.respondError("Node is not of type script or stylesheet"),!1):(b.value.launchMode=c.launchMode,CRM.updateCrm(),a.respondSuccess(Helpers.safe(b)),!0)})})})},a.getLaunchMode=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){"script"===b.type||"stylesheet"===b.type?a.respondSuccess(b.value.launchMode):a.respondError("Node is not of type script or stylesheet")})})},a.registerLibrary=function(a){a.checkPermissions(["crmWrite"],function(){a.typeCheck([{val:"name",type:"string"},{val:"url",type:"string",optional:!0},{val:"code",type:"string",optional:!0}],function(b){var c,d=a.message.data;if(b.url){if(d.url.indexOf(".js")!==d.url.length-3)return a.respondError("No valid URL given"),!1;var e=!1,f=new window.XMLHttpRequest;f.open("GET",d.url,!0),f.onreadystatechange=function(){4===f.readyState&&200===f.status&&(e=!0,c={name:d.name,code:f.responseText,url:d.url},globalObject.globals.storages.storageLocal.libraries.push(c),chrome.storage.local.set({libraries:globalObject.globals.storages.storageLocal.libraries}),a.respondSuccess(c))},setTimeout(function(){e||a.respondError("Request timed out")},5e3),f.send()}else{if(!b.code)return a.respondError("No URL or code given"),!1;c={name:d.name,code:d.code},globalObject.globals.storages.storageLocal.libraries.push(c),chrome.storage.local.set({libraries:globalObject.globals.storages.storageLocal.libraries}),a.respondSuccess(c)}return!0})})},a.scriptLibraryPush=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"libraries",type:["object","array"],forChildren:[{val:"name",type:"string"}]},{val:"libraries.name",type:"string",optional:!0}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){function d(a){for(var b=0;b<globalObject.globals.storages.storageLocal.libraries.length;b++)if(globalObject.globals.storages.storageLocal.libraries[b].name.toLowerCase()===a.name.toLowerCase())return globalObject.globals.storages.storageLocal.libraries[b].name;return!1}function e(a,b){for(var c=0;c<a.value.libraries.length;c++)if(a.value.libraries[c].name===(b.name||null)&&a.value.libraries[c].url===(b.url||null))return!0;return!1}if("script"!==c.type)return a.respondError("Node is not of type script"),!1;var f=b.libraries;if(Array.isArray(f))for(var g=0;g<f.length;g++){var h=f[g].name;if(!(f[g].name=d(f[g])))return a.respondError("Library "+h+" is not registered"),!1;e(c,f[g])||c.value.libraries.push(f[g])}else{var i=f.name;if(!(f.name=d(f)))return a.respondError("Library "+i+" is not registered"),!1;e(c,f)||c.value.libraries.push(f)}return CRM.updateCrm(),a.respondSuccess(Helpers.safe(c).value.libraries),!0})})})},a.scriptLibrarySplice=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"start",type:"number"},{val:"amount",type:"number"}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c,d=a.message.data;return"script"===b.type?(c=Helpers.safe(b).value.libraries.splice(d.start,d.amount),CRM.updateCrm(),a.respondSuccess(c,Helpers.safe(b).value.libraries)):a.respondError("Node is not of type script"),!0})})})},a.scriptBackgroundLibraryPush=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"libraries",type:["object","array"],forChildren:[{val:"name",type:"string"}]},{val:"libraries.name",type:"string",optional:!0}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){function c(a){for(var b=0;b<globalObject.globals.storages.storageLocal.libraries.length;b++)if(globalObject.globals.storages.storageLocal.libraries[b].name.toLowerCase()===a.name.toLowerCase())return globalObject.globals.storages.storageLocal.libraries[b].name;return!1}function d(a,b){for(var c=0;c<a.value.libraries.length;c++)if(a.value.libraries[c].name===(b.name||null)&&a.value.libraries[c].url===(b.url||null))return!0;return!1}var e=a.message.data;if("script"!==b.type)return a.respondError("Node is not of type script"),!1;var f=e.libraries;if(Array.isArray(f))for(var g=0;g<f.length;g++){var h=f[g].name;if(!(f[g].name=c(f[g])))return a.respondError("Library "+h+" is not registered"),!1;d(b,f[g])||b.value.backgroundLibraries.push(f[g])}else{var i=f.name;if(!(f.name=c(f)))return a.respondError("Library "+i+" is not registered"),!1;d(b,f)||b.value.backgroundLibraries.push(e.libraries)}return CRM.updateCrm(),a.respondSuccess(Helpers.safe(b).value.backgroundLibraries),!0})})})},a.scriptBackgroundLibrarySplice=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"start",type:"number"},{val:"amount",type:"number"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){var d;return"script"===c.type?(d=Helpers.safe(c).value.backgroundLibraries.splice(b.start,b.amount),CRM.updateCrm([a.message.data.nodeId]),a.respondSuccess(d,Helpers.safe(c).value.backgroundLibraries)):(c.scriptVal=c.scriptVal||globalObject.globals.constants.templates.getDefaultScriptValue(),c.scriptVal.backgroundLibraries=c.scriptVal.backgroundLibraries||[],d=c.scriptVal.backgroundLibraries.splice(b.start,b.amount),CRM.updateCrm([a.message.data.nodeId]),a.respondSuccess(d,c.scriptVal.backgroundLibraries)),!0})})})},a.setScriptValue=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"script",type:"string"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){return"script"===c.type?c.value.script=b.script:(c.scriptVal=c.scriptVal||globalObject.globals.constants.templates.getDefaultScriptValue(),c.scriptVal.script=b.script),CRM.updateCrm(),a.respondSuccess(Helpers.safe(c)),!0})})})},a.getScriptValue=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){"script"===b.type?a.respondSuccess(b.value.script):b.scriptVal?a.respondSuccess(b.scriptVal.script):a.respondSuccess(void 0)})})},a.setStylesheetValue=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"stylesheet",type:"string"}],function(){a.getNodeFromId(a.message.data.nodeId).run(function(b){var c=a.message.data;return"stylesheet"===b.type?b.value.stylesheet=c.stylesheet:(b.stylesheetVal=b.stylesheetVal||globalObject.globals.constants.templates.getDefaultStylesheetValue(),b.stylesheetVal.stylesheet=c.stylesheet),CRM.updateCrm(),a.respondSuccess(Helpers.safe(b)),!0})})})},a.getStylesheetValue=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){"stylesheet"===b.type?a.respondSuccess(b.value.stylesheet):b.stylesheetVal?a.respondSuccess(b.stylesheetVal.stylesheet):a.respondSuccess(void 0)})})},a.setBackgroundScriptValue=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"script",type:"string"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){return"script"===c.type?c.value.backgroundScript=b.script:(c.scriptVal=c.scriptVal||globalObject.globals.constants.templates.getDefaultScriptValue(),c.scriptVal.backgroundScript=b.script),CRM.updateCrm([a.message.data.nodeId]),a.respondSuccess(Helpers.safe(c)),!0})})})},a.getBackgroundScriptValue=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){"script"===b.type?a.respondSuccess(b.value.backgroundScript):b.scriptVal?a.respondSuccess(b.scriptVal.backgroundScript):a.respondSuccess(void 0)})})},a.getMenuChildren=function(a){a.checkPermissions(["crmGet"],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){"menu"===b.type?a.respondSuccess(b.children):a.respondError("Node is not of type menu")})})},a.setMenuChildren=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"childrenIds",type:"array"}],function(){a.getNodeFromId(a.message.data.nodeId,!0).run(function(b){var c=a.message.data;if("menu"!==b.type)return a.respondError("Node is not of type menu"),!1;for(var d=0;d<c.childrenIds.length;d++)if("number"!=typeof c.childrenIds[d])return a.respondError("Not all values in array childrenIds are of type number"),!1;for(var e=b.children.length,d=0;d<c.childrenIds.length;d++){var f=a.getNodeFromId(c.childrenIds[d],!1,!0);a.moveNode(f,{relation:"lastChild",node:a.message.data.nodeId},{children:a.lookup(f.path,globalObject.globals.crm.crmTree,!0),index:f.path[f.path.length-1]})}return a.getNodeFromId(b.id,!1,!0).children.splice(0,e),CRM.updateCrm(),a.respondSuccess(a.getNodeFromId(b.id,!0,!0)),!0})})})},a.pushMenuChildren=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"childrenIds",type:"array"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId,!0).run(function(c){"menu"!==c.type&&a.respondError("Node is not of type menu");for(var d=0;d<b.childrenIds.length;d++)if("number"!=typeof b.childrenIds[d])return a.respondError("Not all values in array childrenIds are of type number"),!1;for(var d=0;d<b.childrenIds.length;d++){var e=a.getNodeFromId(b.childrenIds[d],!1,!0);a.moveNode(e,{relation:"lastChild",node:a.message.data.nodeId},{children:a.lookup(e.path,globalObject.globals.crm.crmTree,!0),index:e.path[e.path.length-1]})}return CRM.updateCrm(),a.respondSuccess(a.getNodeFromId(c.id,!0,!0)),!0})})})},a.spliceMenuChildren=function(a){a.checkPermissions(["crmGet","crmWrite"],function(){a.typeCheck([{val:"start",type:"number"},{val:"amount",type:"number"}],function(){var b=a.message.data;a.getNodeFromId(a.message.data.nodeId).run(function(c){if("menu"!==c.type)return a.respondError("Node is not of type menu"),!1;var d=c.children.splice(b.start,b.amount);return CRM.updateCrm(),a.respondSuccess(d.map(function(a){return CRM.makeSafe(a)}),a.getNodeFromId(c.id,!0,!0).children),!0})})})},a}(),APIMessaging=function(){function a(){}return a.createReturn=function(a,b){var c=this;return function(d){c.CRMMessage.respond(a,"success",{callbackId:b,params:[d]})}},a.sendThroughComm=function(a){var b=globalObject.globals.crmValues.nodeInstances[a.id],c=[],d=function(a){b.hasOwnProperty(a)&&b[a].forEach(function(d,e){c.push({id:a,tabIndex:e,instance:b[a][e]})})};for(var e in b)d(e);for(var f=[],g=[],h=0;h<a.args.length;h++)"fn"===a.args[h].type?g.push(a.args[h]):"arg"===a.args[h].type&&(f.length>2&&"string"==typeof f[0]&&(f=f.slice(1)),f.push(a.args[h]));g.length>0&&console.warn("Message responseCallbacks are not supported");for(var h=0;h<c.length;h++)globalObject.globals.crmValues.tabData[c[h].id].nodes[a.id][c[h].tabIndex].port.postMessage({messageType:"instanceMessage",message:f[0]})},a}();APIMessaging.CRMMessage=function(){function a(){}return a.respond=function(a,b,c,d){var e={type:b,callbackId:a.onFinish,messageType:"callback"};e.data="error"===b||"chromeError"===b?{error:c,stackTrace:d,lineNumber:a.lineNumber}:c;try{globalObject.globals.crmValues.tabData[a.tabId].nodes[a.id][a.tabIndex].port.postMessage(e)}catch(b){if("Converting circular structure to JSON"!==b.message)throw b;APIMessaging.CRMMessage.respond(a,"error","Converting circular structure to JSON, this API will not work")}},a}(),APIMessaging.ChromeMessage=function(){function a(){}return a.throwError=function(a,b,c){if(console.warn("Error:",b),c){var d=c.split("\n");d.forEach(function(a){console.warn(a)})}APIMessaging.CRMMessage.respond(a,"chromeError",b,c)},a}();var CRMFunction=function(){function a(a,b){this.message=a,this.action=b,CRMFunctions[b](this)}return a.prototype.respondSuccess=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return APIMessaging.CRMMessage.respond(this.message,"success",a),!0},a.prototype.respondError=function(a){APIMessaging.CRMMessage.respond(this.message,"error",a)},a.prototype.lookup=function(a,b,c){if(void 0===c&&(c=!1),null===a||"object"!=typeof a||!Array.isArray(a))return this.respondError("Supplied path is not of type array"),!0;for(var d=a.length-1,e=0;e<d;e++){var f=b[a[e]];if(!(b&&f&&f.children))return!1;b=f.children}return(c?b:b[a[d]])||!1},a.prototype.checkType=function(a,b,c,d,e,f,g){return void 0===d&&(d=0),void 0===f&&(f=!1),void 0===a||null===a?d?(e&&e(),!0):(f?this.respondError("Not all values for "+c+" are defined"):this.respondError("Value for "+c+" is not defined"),!1):"array"!==b||"object"==typeof a&&!Array.isArray(a)?typeof a!==b?(f?this.respondError("Not all values for "+c+" are of type "+b+", they are instead of type "+typeof a):this.respondError("Value for "+c+" is not of type "+b+", it is instead of type "+typeof a),!1):(g&&g(),!0):(f?this.respondError("Not all values for "+c+" are of type "+b+", they are instead of type "+typeof a):this.respondError("Value for "+c+" is not of type "+b+", it is instead of type "+typeof a),!1)},a.prototype.moveNode=function(b,c,d){void 0===d&&(d=!1);var e,f=this,g=JSON.parse(JSON.stringify(globalObject.globals.crm.crmTree));if(c=c||{},!this.checkType(c,"object","position"))return!1;if(!this.checkType(c.node,"number","node",1,null,!1,function(){!(e=f.getNodeFromId(c.node,!1,!0))}))return!1;if(!this.checkType(c.relation,"string","relation",1))return!1;e=e||globalObject.globals.crm.crmTree;var h=e===globalObject.globals.crm.crmTree;switch(c.relation){case"before":a.MoveNode.before(h,b,d,e,this);break;case"firstSibling":a.MoveNode.firstSibling(h,b,d,e,this);break;case"after":a.MoveNode.after(h,b,e,this);break;case"lastSibling":a.MoveNode.lastSibling(h,b,e,this);break;case"firstChild":if(!a.MoveNode.firstChild(h,b,d,e,this))return!1;break;default:case"lastChild":if(!a.MoveNode.lastChild(h,b,e,this))return!1}return d&&d.children.splice(d.index,1),Storages.applyChanges({type:"optionsPage",settingsChanges:[{key:"crm",oldValue:g,newValue:JSON.parse(JSON.stringify(globalObject.globals.crm.crmTree))}]}),b},a.prototype.getNodeFromId=function(a,b,c){void 0===b&&(b=!1),void 0===c&&(c=!1);var d=(b?globalObject.globals.crm.crmByIdSafe:globalObject.globals.crm.crmById)[a];return d?c?d:{run:function(a){a(d)}}:(this.respondError("There is no node with the id you supplied ("+a+")"),!c&&{run:function(){}})},a._getDotValue=function(a,b){for(var c=b.split("."),d=a,e=0;e<c.length;e++){if(!(c[e]in d))return;d=d[c[e]]}return d},a.prototype.dependencyMet=function(a,b){return!(a.dependency&&!b[a.dependency])||(b[a.val]=!1,!1)},a.prototype._isDefined=function(a,b,c){return void 0!==b&&null!==b||(a.optional?(c[a.val]=!1,"continue"):(this.respondError("Value for "+a.val+" is not set"),!1))},a.prototype._typesMatch=function(a,b){for(var c=Array.isArray(a.type)?a.type:[a.type],d=0;d<c.length;d++){var e=c[d];if("array"===e&&"object"==typeof b&&Array.isArray(b))return e;if(typeof b===e)return e}return this.respondError("Value for "+a.val+" is not of type "+c.join(" or ")),null},a.prototype._checkNumberConstraints=function(a,b){return void 0!==a.min&&a.min>b?(this.respondError("Value for "+a.val+" is smaller than "+a.min),!1):!(void 0!==a.max&&a.max<b)||(this.respondError("Value for "+a.val+" is bigger than "+a.max),!1)},a.prototype._checkArrayChildType=function(a,b,c){for(var d=Array.isArray(c.type)?c.type:[c.type],e=0;e<d.length;e++){var f=d[e];if("array"===f){if(Array.isArray(b))return!0}else if(typeof b===f)return!0}return this.respondError("For not all values in the array "+a.val+" is the property "+c.val+" of type "+d.join(" or ")),!1},a.prototype._checkArrayChildrenConstraints=function(a,b){for(var c=0;c<b.length;c++)for(var d=0;d<a.forChildren.length;d++){var e=a.forChildren[d],f=b[c][e.val];if(void 0===f||null===f){if(!e.optional)return this.respondError("For not all values in the array "+a.val+" is the property "+e.val+" defined"),!1}else if(!this._checkArrayChildType(a,f,e))return!1}return!0},a.prototype._checkConstraints=function(a,b,c){return"number"==typeof b?this._checkNumberConstraints(a,b):!Array.isArray(b)||!a.forChildren||this._checkArrayChildrenConstraints(a,b)},a.prototype.typeCheck=function(b,c){for(var d={},e=0;e<b.length;e++){var f=b[e];if(this.dependencyMet(f,d)){var g=a._getDotValue(this.message.data,f.val),h=this._isDefined(f,g,d);if(h===!0){var i=this._typesMatch(f,g);if(i){d[f.val]=!0,this._checkConstraints(f,g,d);continue}}else if("continue"===h)continue;return!1}}return c(d),!0},a.prototype.checkPermissions=function(a,b){var c,d=[],e=!0;if(!(c=globalObject.globals.crm.crmById[this.message.id]))return this.respondError("The node you are running this script from no longer exist, no CRM API calls are allowed"),!1;if(c.isLocal)b&&b(d);else{var f=[];if(!c.permissions||Helpers.compareArray(c.permissions,[]))a.length>0&&(e=!1,f=a);else for(var g=0;g<a.length;g++)c.permissions.indexOf(a[g])===-1&&(e=!1,f.push(a[g]));if(e){for(var h=d.length,g=0;g<h;g++)c.permissions.indexOf(d[g])===-1&&(d.splice(g,1),h--,g--);b&&b(d)}else this.respondError("Permission"+(1===f.length?" "+f[0]:"s "+f.join(", "))+" are not available to this script.")}return!0},a}();CRMFunction.MoveNode=function(){function a(){}return a.before=function(a,b,c,d,e){if(a)Helpers.pushIntoArray(b,0,globalObject.globals.crm.crmTree),c&&globalObject.globals.crm.crmTree===c.children&&c.index++;else{var f=e.lookup(d.path,globalObject.globals.crm.crmTree,!0);Helpers.pushIntoArray(b,d.path[d.path.length-1],f),c&&f===c.children&&c.index++}},a.firstSibling=function(a,b,c,d,e){if(a)Helpers.pushIntoArray(b,0,globalObject.globals.crm.crmTree),c&&globalObject.globals.crm.crmTree===c.children&&c.index++;else{var f=e.lookup(d.path,globalObject.globals.crm.crmTree,!0);Helpers.pushIntoArray(b,0,f),c&&f===c.children&&c.index++}},a.after=function(a,b,c,d){if(a)Helpers.pushIntoArray(b,globalObject.globals.crm.crmTree.length,globalObject.globals.crm.crmTree);else{var e=d.lookup(c.path,globalObject.globals.crm.crmTree,!0);c.path.length>0&&Helpers.pushIntoArray(b,c.path[c.path.length-1]+1,e)}},a.lastSibling=function(a,b,c,d){if(a)Helpers.pushIntoArray(b,globalObject.globals.crm.crmTree.length,globalObject.globals.crm.crmTree);else{var e=d.lookup(c.path,globalObject.globals.crm.crmTree,!0);Helpers.pushIntoArray(b,e.length,e)}},a.firstChild=function(a,b,c,d,e){if(a)Helpers.pushIntoArray(b,0,globalObject.globals.crm.crmTree),c&&globalObject.globals.crm.crmTree===c.children&&c.index++;else{if("menu"!==d.type)return e.respondError('Supplied node is not of type "menu"'),!1;Helpers.pushIntoArray(b,0,d.children),c&&d.children===c.children&&c.index++}return!0},a.lastChild=function(a,b,c,d){if(a)Helpers.pushIntoArray(b,globalObject.globals.crm.crmTree.length,globalObject.globals.crm.crmTree);else{if("menu"!==c.type)return d.respondError('Supplied node is not of type "menu"'),!1;Helpers.pushIntoArray(b,c.children.length,c.children)}return!0},a}();var ChromeHandler=function(){function a(){}return a.handle=function(a){if(!this._handleSpecialCalls(a))return!1;var b=a.requestType||a.api.split(".")[0];if(!this._hasPermission(a,b))return!1;if(globalObject.globals.constants.permissions.indexOf(b)===-1)return APIMessaging.ChromeMessage.throwError(a,"Permissions "+b+" is not available for use or does not exist."),!1;if(globalObject.globals.availablePermissions.indexOf(b)===-1)return APIMessaging.ChromeMessage.throwError(a,"Permissions "+b+" not available to the extension, visit options page"),chrome.storage.local.get("requestPermissions",function(a){var c=a.requestPermissions||[b];chrome.storage.local.set({requestPermissions:c})}),!1;for(var c=[],d=[],e=0;e<a.args.length;e++)switch(a.args[e].type){case"arg":c.push(Helpers.jsonFn.parse(a.args[e].val));break;case"fn":c.push(this._createChromeFnCallbackHandler(a,a.args[e].val));break;case"return":d.push(APIMessaging.createReturn(a,a.args[e].val))}try{for(var f=sandboxes.sandboxChrome(a.api,c),e=0;e<d.length;e++)d[e](f)}catch(b){return APIMessaging.ChromeMessage.throwError(a,b.message,b.stack),!1}return!0},a._hasPermission=function(a,b){var c=globalObject.globals.crm.crmById[a.id];if(!c.isLocal){var d=void 0,e=c.permissions.indexOf("chrome")!==-1;if(d=c.permissions.indexOf(b)!==-1,!e&&!d)return APIMessaging.ChromeMessage.throwError(a,"Both permissions chrome and "+b+" not available to this script"),!1;if(!e)return APIMessaging.ChromeMessage.throwError(a,"Permission chrome not available to this script"),!1;if(!d)return APIMessaging.ChromeMessage.throwError(a,"Permission "+b+" not avilable to this script"),!1}return!0},a._handleSpecialCalls=function(a){return/[a-zA-Z0-9]*/.test(a.api)?!this._checkForRuntimeMessages(a)&&("runtime.sendMessage"!==a.api||(console.warn("The chrome.runtime.sendMessage API is not meant to be used, use crmAPI.comm instead"),APIMessaging.sendThroughComm(a),!1)):(APIMessaging.ChromeMessage.throwError(a,'Passed API "'+a.api+'" is not alphanumeric.'),!1)},a._handlePossibleChromeEvent=function(a,b){if(b.split(".").length>1){a.args[0]&&"fn"===a.args[0].type||APIMessaging.ChromeMessage.throwError(a,"First argument should be a function");var c=["onStartup","onInstalled","onSuspend","onSuspendCanceled","onUpdateAvailable","onRestartRequired"],d=b.split(".")[0];return c.indexOf(d)>-1?(chrome.runtime[d].addListener(function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];var d=Array.prototype.slice.apply(b);APIMessaging.CRMMessage.respond(a,"success",{callbackId:a.args[0].val,params:d})}),!0):"onMessage"===d?(APIMessaging.ChromeMessage.throwError(a,"This method of listening to messages is not allowed, use crmAPI.comm instead"),!0):(APIMessaging.ChromeMessage.throwError(a,"You are not allowed to listen to given event"),!0)}return!1},a._checkForRuntimeMessages=function(a){var b=a.api.split(".").slice(1).join(".");if("runtime"!==a.api.split(".")[0])return!1;switch(b){case"getBackgroundPage":return this.ChromeAPIs.getBackgroundPage(a,b);case"openOptionsPage":return this.ChromeAPIs.openOptionsPage(a,b);case"getManifest":return this.ChromeAPIs.getManifest(a,b);case"getURL":return this.ChromeAPIs.getURL(a,b);case"connect":case"connectNative":case"setUninstallURL":case"sendNativeMessage":case"requestUpdateCheck":return this.ChromeAPIs.unaccessibleAPI(a);case"reload":return this.ChromeAPIs.reload(a,b);case"restart":return this.ChromeAPIs.restart(a,b);case"restartAfterDelay":return this.ChromeAPIs.restartAfterDelay(a,b);case"getPlatformInfo":return this.ChromeAPIs.getPlatformInfo(a,b);case"getPackageDirectoryEntry":return this.ChromeAPIs.getPackageDirectoryEntry(a,b)}return this._handlePossibleChromeEvent(a,b)},a._createChromeFnCallbackHandler=function(a,b){return function(){for(var c=[],d=0;d<arguments.length;d++)c[d]=arguments[d];APIMessaging.CRMMessage.respond(a,"success",{callbackId:b,params:c})}},a}();ChromeHandler.ChromeAPIs=function(){function a(){}return a._checkFirstRuntimeArg=function(a,b,c){return(!a.args[0]||a.args[0].type!==b)&&(APIMessaging.ChromeMessage.throwError(a,"fn"===b?"First argument of "+c+" should be a function":c+" should have a function to retunr to"),!0)},a._respondSuccess=function(a,b){APIMessaging.CRMMessage.respond(a,"success",{callbackId:a.args[0].val,params:b})},a.getBackgroundPage=function(a,b){return console.warn("The chrome.runtime.getBackgroundPage API should not be used"),!!this._checkFirstRuntimeArg(a,"fn",b)||(this._respondSuccess(a,[{}]),!0)},a.openOptionsPage=function(a,b){var c=this;return!!this._checkFirstRuntimeArg(a,"fn",b)||(chrome.runtime.openOptionsPage(function(){
a.args[0]&&c._respondSuccess(a,[])}),!0)},a.getManifest=function(a,b){return!!this._checkFirstRuntimeArg(a,"return",b)||(APIMessaging.createReturn(a,a.args[0].val)(chrome.runtime.getManifest()),!0)},a.getURL=function(a,b){for(var c=[],d=[],e=0;e<a.args.length;e++)if("return"===a.args[e].type)c.push(a.args[e].val);else{if("arg"!==a.args[e].type)return APIMessaging.ChromeMessage.throwError(a,"getURL should not have a function as an argument"),!0;d.push(a.args[e].val)}return 0!==c.length&&0!==d.length||APIMessaging.ChromeMessage.throwError(a,"getURL should be a return function with at least one argument"),APIMessaging.createReturn(a,c[0])(chrome.runtime.getURL(d[0])),!0},a.unaccessibleAPI=function(a){return APIMessaging.ChromeMessage.throwError(a,"This API should not be accessed"),!0},a.reload=function(a,b){return chrome.runtime.reload(),!0},a.restart=function(a,b){return chrome.runtime.restart(),!0},a.restartAfterDelay=function(a,b){for(var c=[],d=[],e=0;e<a.args.length;e++)if("fn"===a.args[e].type)c.push(a.args[e].val);else{if("arg"!==a.args[e].type)return APIMessaging.ChromeMessage.throwError(a,"restartAfterDelay should not have a return as an argument"),!0;d.push(a.args[e].val)}return chrome.runtime.restartAfterDelay(d[0],function(){APIMessaging.CRMMessage.respond(a,"success",{callbackId:c[0],params:[]})}),!0},a.getPlatformInfo=function(a,b){var c=this;return!!this._checkFirstRuntimeArg(a,"fn",b)||(chrome.runtime.getPlatformInfo(function(b){a.args[0]&&c._respondSuccess(a,[b])}),!0)},a.getPackageDirectoryEntry=function(a,b){var c=this;return!!this._checkFirstRuntimeArg(a,"fn",b)||(chrome.runtime.getPackageDirectoryEntry(function(b){a.args[0]&&c._respondSuccess(a,[b])}),!0)},a.parent=function(){return ChromeHandler},a}();var Resources=function(){function a(){}return a.handle=function(b,c){switch(b.type){case"register":a._registerResource(c,b.url,b.scriptId);break;case"remove":a._removeResource(c,b.scriptId)}},a.checkIfResourcesAreUsed=function(){var a=[];for(var b in globalObject.globals.storages.resources)if(globalObject.globals.storages.resources.hasOwnProperty(b)&&globalObject.globals.storages.resources[b]){var c=globalObject.globals.storages.resources[b];for(var d in c)c.hasOwnProperty(d)&&c[d]&&a.push(c[d].name)}for(var e in globalObject.globals.crm.crmById){var f=void 0;if(globalObject.globals.crm.crmById.hasOwnProperty(e)&&(f=globalObject.globals.crm.crmById[e])&&"script"===f.type&&f.value.script){for(var g={},h=CRM.Script.MetaTags.getMetaTags(globalObject.globals.crm.crmById[e].value.script),i=h.resource,j=f.value.libraries,k=0;k<j.length;k++)j[k].name||(g[j[k].url]=!0);for(var k=0;k<i;k++)g[i[k]]=!0;for(var k=0;k<a.length;k++)g[a[k]]||this._removeResource(a[k],~~e)}}},a.updateResourceValues=function(){for(var a=0;a<globalObject.globals.storages.resourceKeys.length;a++)console.log("Updating resources..."),setTimeout(this._generateUpdateCallback(globalObject.globals.storages.resourceKeys[a]),1e3*a)},a._getUrlData=function(a,b,c){globalObject.globals.storages.urlDataPairs[b]?(globalObject.globals.storages.urlDataPairs[b].refs.indexOf(a)===-1&&globalObject.globals.storages.urlDataPairs[b].refs.push(a),c(globalObject.globals.storages.urlDataPairs[b].dataURI,globalObject.globals.storages.urlDataPairs[b].dataString)):Helpers.convertFileToDataURI(b,function(d,e){globalObject.globals.storages.urlDataPairs[b]={dataURI:d,dataString:e,refs:[a]},c(d,e)})},a._getHashes=function(a){var b=[],c=a.split("#")[1];if(!c)return[];var d=c.split(/[,|;]/g);return d.forEach(function(a){var c=a.split("=");b.push({algorithm:c[0],hash:c[1]})}),b},a._doAlgorithm=function(a,b,c){window.crypto.subtle.digest(a,b).then(function(a){return String.fromCharCode.apply(null,a)===c.hash})},a._algorithmNameToFnName=function(a){for(var b=0,c=0;c<a.length;c++)if(a.charCodeAt(c)>=48&&a.charCodeAt(c)<=57){b=c;break}return a.slice(0,b).toUpperCase()+"-"+a.slice(b)},a._matchesHashes=function(a,b){if(0===a.length)return!0;var c=null;a=a.reverse();for(var d=0;d<a.length;d++){var e=a[d].algorithm.toLowerCase();if(globalObject.globals.constants.supportedHashes.indexOf(e)!==-1){c={algorithm:e,hash:a[d].hash};break}}if(null===c)return!1;var f=new window.TextEncoder("utf-8").encode(b);switch(c.algorithm){case"md5":return window.md5(b)===c.hash;case"sha1":case"sha384":case"sha512":this._doAlgorithm(this._algorithmNameToFnName(c.algorithm),f,c)}return!1},a._registerResource=function(a,b,c){var d=this,e=this._getHashes(b);window.navigator.onLine&&this._getUrlData(c,b,function(f,g){var h=globalObject.globals.storages.resources;h[c]=h[c]||{},h[c][a]={name:a,sourceUrl:b,dataURI:f,hashes:e,matchesHashes:d._matchesHashes(e,g),crmUrl:"chrome-extension://"+chrome.runtime.id+"/resource/"+c+"/"+a},chrome.storage.local.set({resources:h,urlDataPairs:globalObject.globals.storages.urlDataPairs})});for(var f=globalObject.globals.storages.resourceKeys,g=0;g<f.length;g++)if(f[g].name===a&&f[g].scriptId===c)return;f.push({name:a,sourceUrl:b,hashes:e,scriptId:c}),chrome.storage.local.set({resourceKeys:f})},a._removeResource=function(a,b){for(var c=0;c<globalObject.globals.storages.resourceKeys.length;c++)if(globalObject.globals.storages.resourceKeys[c].name===a&&globalObject.globals.storages.resourceKeys[c].scriptId===b){globalObject.globals.storages.resourceKeys.splice(c,1);break}if(globalObject.globals.storages.resources[b]&&globalObject.globals.storages.resources[b][a]&&globalObject.globals.storages.resources[b][a].sourceUrl){var d=globalObject.globals.storages.urlDataPairs[globalObject.globals.storages.resources[b][a].sourceUrl];d&&(d.refs.splice(d.refs.indexOf(b),1),0===d.refs.length&&delete globalObject.globals.storages.urlDataPairs[globalObject.globals.storages.resources[b][a].sourceUrl]),globalObject.globals.storages.resources&&globalObject.globals.storages.resources[b]&&globalObject.globals.storages.resources[b][a]&&delete globalObject.globals.storages.resources[b][a],chrome.storage.local.set({resourceKeys:globalObject.globals.storages.resourceKeys,resources:globalObject.globals.storages.resources,urlDataPairs:globalObject.globals.storages.urlDataPairs})}},a._compareResource=function(a){var b=this,c=globalObject.globals.storages.resources;Helpers.convertFileToDataURI(a.sourceUrl,function(d,e){if(!c[a.scriptId]||!c[a.scriptId][a.name]||c[a.scriptId][a.name].dataURI!==d){var f=c[a.scriptId][a.name];b._matchesHashes(f.hashes,e)&&(globalObject.globals.storages.urlDataPairs[a.sourceUrl].dataURI=d,globalObject.globals.storages.urlDataPairs[a.sourceUrl].dataString=e,chrome.storage.local.set({resources:c,urlDataPairs:globalObject.globals.storages.urlDataPairs}))}})},a._generateUpdateCallback=function(a){var b=this;return function(){b._compareResource(a)}},a}();Resources.Resource=function(){function a(){}return a.handle=function(a){Resources.handle(a,a.name)},a}(),Resources.Anonymous=function(){function a(){}return a.handle=function(a){Resources.handle(a,a.url)},a}();var MessageHandling=function(){function a(){}return a.handleRuntimeMessage=function(a,b,c){switch(a.type){case"executeCRMCode":case"getCRMHints":case"createLocalLogVariable":Logging.LogExecution.executeCRMCode(a.data,a.type);break;case"displayHints":Logging.LogExecution.displayHints(a);break;case"logCrmAPIValue":Logging.logHandler(a.data);break;case"resource":Resources.Resource.handle(a.data);break;case"anonymousLibrary":Resources.Anonymous.handle(a.data);break;case"updateStorage":Storages.applyChanges(a.data);break;case"sendInstanceMessage":this.Instances.sendMessage(a);break;case"sendBackgroundpageMessage":this.BackgroundPageMessage.send(a.data);break;case"respondToBackgroundMessage":this.Instances.respond({onFinish:a.data.response,tabIndex:a.data.tabIndex,id:a.data.id,tabId:a.data.tabId},"success",a.data.message);break;case"changeInstanceHandlerStatus":this.Instances.changeStatus(a);break;case"addNotificationListener":this.NotificationListener.listen(a);break;case"newTabCreated":b&&c&&CRM.Script.Running.executeScriptsForTab(b.tab.id,c);break;case"styleInstall":CRM.Stylesheet.Installing.installStylesheet(a.data);break;case"updateScripts":CRM.Script.Updating.updateScripts(function(a){c&&c(a)});break;case"installUserScript":CRM.Script.Updating.install(a.data);break;case"applyLocalStorage":localStorage.setItem(a.data.key,a.data.value)}},a.handleCrmAPIMessage=function(a){switch(a.type){case"crm":new CRMFunction(a,a.action);break;case"chrome":ChromeHandler.handle(a);break;default:this.handleRuntimeMessage(a)}},a.signalNewCRM=function(){var a=CRM.converToLegacy(),b=globalObject.globals.crmValues.tabData;for(var c in b)for(var d in b[c].nodes)b[c].nodes[d].forEach(function(b){if(b.usesLocalStorage&&globalObject.globals.crm.crmById[d].isLocal)try{b.port.postMessage({messageType:"localStorageProxy",message:a})}catch(a){}})},a}();MessageHandling.Instances=function(){function a(){}return a.respond=function(a,b,c){var d={type:b,callbackId:a.onFinish,messageType:"callback",data:c};try{globalObject.globals.crmValues.tabData[a.tabId].nodes[a.id][a.tabIndex].port.postMessage(d)}catch(b){if("Converting circular structure to JSON"!==b.message)throw b;this.respond(a,"error","Converting circular structure to JSON, getting a response from this API will not work")}},a.sendMessage=function(a){var b=a.data,c=globalObject.globals.crmValues.tabData;globalObject.globals.crmValues.nodeInstances[b.id][b.toInstanceId]&&c[b.toInstanceId]&&c[b.toInstanceId].nodes[b.id]?globalObject.globals.crmValues.nodeInstances[b.id][b.toInstanceId][b.toTabIndex].hasHandler?(c[b.toInstanceId].nodes[b.id][b.toTabIndex].port.postMessage({messageType:"instanceMessage",message:b.message}),this.respond(a,"success")):this.respond(a,"error","no listener exists"):this.respond(a,"error","instance no longer exists")},a.changeStatus=function(a){globalObject.globals.crmValues.nodeInstances[a.id][a.tabId][a.tabIndex].hasHandler=a.data.hasHandler},a}(),MessageHandling.BackgroundPageMessage=function(){function a(){}return a.send=function(a){var b=a.message,c=a.response;globalObject.globals.background.byId[a.id].post({type:"comm",message:{type:"backgroundMessage",message:b,respond:c,tabId:a.tabId}})},a}(),MessageHandling.NotificationListener=function(){function a(){}return a.listen=function(a){var b=a.data;globalObject.globals.notificationListeners[b.notificationId]={id:b.id,tabId:b.tabId,tabIndex:b.tabIndex,notificationId:b.notificationId,onDone:b.onDone,onClick:b.onClick}},a}();var CRM=function(){function a(){}return a.updateCrm=function(b){Storages.uploadChanges("settings",[{key:"crm",newValue:JSON.parse(JSON.stringify(globalObject.globals.crm.crmTree)),oldValue:{}}]),a.updateCRMValues(),a.buildPageCRM(),MessageHandling.signalNewCRM(),b&&Storages.checkBackgroundPagesForChange([],b)},a.updateCRMValues=function(){var a=JSON.stringify(globalObject.globals.storages.settingsStorage.crm);Storages.crmForEach(globalObject.globals.storages.settingsStorage.crm,function(a){a.id||0===a.id||(a.id=Helpers.generateItemId())});var b=a===JSON.stringify(globalObject.globals.storages.settingsStorage.crm);globalObject.globals.crm.crmTree=globalObject.globals.storages.settingsStorage.crm,globalObject.globals.crm.safeTree=this._buildSafeTree(globalObject.globals.storages.settingsStorage.crm),this._buildNodePaths(globalObject.globals.crm.crmTree,[]),this._buildByIdObjects(),b||Storages.uploadChanges("settings",[{key:"crm",newValue:JSON.parse(JSON.stringify(globalObject.globals.crm.crmTree)),oldValue:{}}])},a.makeSafe=function(a){var b={};if(a.children){var c=b;c.children=[];for(var d=0;d<a.children.length;d++)c.children[d]=this.makeSafe(a.children[d]);b=c}var e=this._createCopyFunction(a,b);return e(["id","path","type","name","value","linkVal","menuVal","scriptVal","stylesheetVal","nodeInfo","triggers","onContentTypes","showOnSpecified"]),b},a.buildPageCRM=function(){var a=globalObject.globals.crm.crmTree.length;globalObject.globals.crmValues.stylesheetNodeStatusses={},chrome.contextMenus.removeAll(),globalObject.globals.crmValues.rootId=chrome.contextMenus.create({title:"Custom Menu",contexts:["all"]}),globalObject.globals.toExecuteNodes={onUrl:{},always:[]};for(var b=0;b<a;b++){var c=this._buildPageCRMTree(globalObject.globals.crm.crmTree[b],globalObject.globals.crmValues.rootId,[b],globalObject.globals.crmValues.contextMenuItemTree);c&&(globalObject.globals.crmValues.contextMenuItemTree[b]={index:b,id:c.id,enabled:!0,node:globalObject.globals.crm.crmTree[b],parentId:globalObject.globals.crmValues.rootId,children:c.children,parentTree:globalObject.globals.crmValues.contextMenuItemTree})}globalObject.globals.storages.storageLocal.showOptions&&(chrome.contextMenus.create({type:"separator",parentId:globalObject.globals.crmValues.rootId}),chrome.contextMenus.create({title:"Options",onclick:this._createOptionsPageHandler(),parentId:globalObject.globals.crmValues.rootId}))},a.getContexts=function(a){for(var b=["browser_action"],c=globalObject.globals.constants.contexts,d=0;d<6;d++)a[d]&&b.push(c[d]);return a[0]&&b.push("editable"),b},a.converToLegacy=function(){for(var a=this._walkCRM(globalObject.globals.crm.crmTree,{arr:[]}).arr,b={},c=0;c<a.length;c++)b[c]=this._convertNodeToLegacy(a[c]);return b.customcolors="0",b.firsttime="no",b.noBeatAnnouncement="true",b.numberofrows=a.length+"",b.optionson=globalObject.globals.storages.storageLocal.showOptions.toString(),b.scriptoptions="0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0",b.waitforsearch="false",b.whatpage="false",b.indexIds=JSON.stringify(a.map(function(a){return a.id})),b},a._convertNodeToLegacy=function(a){switch(a.type){case"divider":return[a.name,"Divider",""].join("%123");case"link":return[a.name,"Link",a.value.map(function(a){return a.url}).join(",")].join("%123");case"menu":return[a.name,"Menu",a.children.length].join("%123");case"script":return[a.name,"Script",[a.value.launchMode,a.value.script].join("%124")].join("%123");case"stylesheet":return[a.name,"Script",[a.value.launchMode,a.value.stylesheet].join("%124")].join("%123")}},a._walkCRM=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];b.arr.push(d),"menu"===d.type&&d.children&&this._walkCRM(d.children,b)}return b},a._createCopyFunction=function(a,b){return function(c){c.forEach(function(c){c in a&&("object"==typeof a[c]?b[c]=JSON.parse(JSON.stringify(a[c])):b[c]=a[c])})}},a._buildNodePaths=function(a,b){for(var c=0;c<a.length;c++){var d=b.concat([c]),e=a[c];e.path=d,e.children&&this._buildNodePaths(e.children,d)}},a._createOptionsPageHandler=function(){return function(){chrome.runtime.openOptionsPage()}},a._buildPageCRMTree=function(a,b,c,d){var e=this.NodeCreation.createNode(a,b);if(globalObject.globals.crmValues.contextMenuIds[a.id]=e,null!==e){var f=[];if(a.children)for(var g=0,h=0;h<a.children.length;h++){var i=JSON.parse(JSON.stringify(c));i.push(g);var j=this._buildPageCRMTree(a.children[h],e,i,f);j&&(g++,j.index=h,j.parentId=e,j.node=a.children[h],j.parentTree=d,f.push(j))}return globalObject.globals.crmValues.contextMenuInfoById[e].path=c,{id:e,path:c,enabled:!0,children:f}}return null},a._parseNode=function(a,b){if(void 0===b&&(b=!1),globalObject.globals.crm[b?"crmByIdSafe":"crmById"][a.id]=b?this.makeSafe(a):a,a.children&&a.children.length>0)for(var c=0;c<a.children.length;c++)this._parseNode(a.children[c],b)},a._buildByIdObjects=function(){globalObject.globals.crm.crmById={},globalObject.globals.crm.crmByIdSafe={};for(var a=0;a<globalObject.globals.crm.crmTree.length;a++)this._parseNode(globalObject.globals.crm.crmTree[a]),this._parseNode(globalObject.globals.crm.safeTree[a],!0)},a._safeTreeParse=function(a){if(a.children){for(var b=[],c=0;c<a.children.length;c++)b.push(this._safeTreeParse(a.children[c]));a.children=b}return this.makeSafe(a)},a._buildSafeTree=function(a){for(var b=JSON.parse(JSON.stringify(a)),c=[],d=0;d<b.length;d++)c.push(this._safeTreeParse(b[d]));return c},a}();CRM.Script=(_c=function(){function a(){}return a._generateMetaAccessFunction=function(a){return function(b){if(a[b])return a[b][0]}},a._getResourcesArrayForScript=function(a){var b=[],c=globalObject.globals.storages.resources[a];if(!c)return[];for(var d in c)c.hasOwnProperty(d)&&b.push(c[d]);return b},a._executeScript=function(a,b,c){var d=this;return chrome.runtime.lastError?(console.log(chrome.runtime.lastError),function(){}):function(){if(b.length>c)try{chrome.tabs.executeScript(a,b[c],d._executeScript(a,b,c+1))}catch(a){}}},a._executeScripts=function(a,b,c){c?chrome.tabs.sendMessage(a,{type:"runScript",data:{scripts:b}}):this._executeScript(a,b,0)()},a}(),_c.Running=function(){function a(){}return a._urlIsGlobalExcluded=function(a){if(globalObject.globals.storages.globalExcludes.indexOf("<all_urls>")>-1)return!0;for(var b=0;b<globalObject.globals.storages.globalExcludes.length;b++){var c=globalObject.globals.storages.globalExcludes[b];if(c&&URLParsing.urlMatchesPattern(c,a))return!0}return!1},a._executeNode=function(a,b){"script"===a.type?CRM.Script.Handler.createHandler(a)({pageUrl:b.url,menuItemId:0,editable:!1},b,!0):"stylesheet"===a.type?CRM.Stylesheet.createClickHandler(a)({pageUrl:b.url,menuItemId:0,editable:!1},b):"link"===a.type&&CRM.Link.createHandler(a)({pageUrl:b.url,menuItemId:0,editable:!1},b)},a.executeScriptsForTab=function(a,b){var c=this;chrome.tabs.get(a,function(a){if(!window.chrome.runtime.lastError&&a.url&&0!==a.url.indexOf("chrome")&&(globalObject.globals.crmValues.tabData[a.id]={libraries:{},nodes:{}},Logging.Listeners.updateTabAndIdLists(),!c._urlIsGlobalExcluded(a.url))){var d=[];for(var e in globalObject.globals.toExecuteNodes.onUrl)globalObject.globals.toExecuteNodes.onUrl.hasOwnProperty(e)&&globalObject.globals.toExecuteNodes.onUrl[e]&&URLParsing.matchesUrlSchemes(globalObject.globals.toExecuteNodes.onUrl[e],a.url)&&d.push({node:globalObject.globals.crm.crmById[e],tab:a});for(var f=0;f<globalObject.globals.toExecuteNodes.always.length;f++)c._executeNode(globalObject.globals.toExecuteNodes.always[f],a);for(var f=0;f<d.length;f++)c._executeNode(d[f].node,d[f].tab);b({matched:d.length>0})}})},a}(),_c.Updating=function(){function Updating(){}return Updating._removeOldNode=function(a){var b=globalObject.globals.crm.crmById[a].children;if(b)for(var c=0;c<b.length;c++)this._removeOldNode(b[c].id);globalObject.globals.background.byId[a]&&(globalObject.globals.background.byId[a].worker.terminate(),delete globalObject.globals.background.byId[a]),delete globalObject.globals.crm.crmById[a],delete globalObject.globals.crm.crmByIdSafe[a];var d=globalObject.globals.crmValues.contextMenuIds[a];void 0!==d&&null!==d&&chrome.contextMenus.remove(d,function(){Helpers.checkForChromeErrors(!1)})},Updating._registerNode=function(node,oldPath){void 0!==oldPath&&null!==oldPath?eval("globalObject.globals.storages.settingsStorage.crm["+oldPath.join("][")+"] = node"):globalObject.globals.storages.settingsStorage.crm.push(node)},Updating._getURL=function(a){var b=document.createElement("a");return b.href=a,b},Updating._updateCRMNode=function(a,b,c,d){var e=!1;void 0!==d&&null!==d&&(e=!0);var f=globalObject.globals.constants.templates;switch(a.type){case"script":a=f.getDefaultScriptNode(a);break;case"stylesheet":a=f.getDefaultStylesheetNode(a);break;case"menu":a=f.getDefaultMenuNode(a);break;case"divider":a=f.getDefaultDividerNode(a);break;case"link":a=f.getDefaultLinkNode(a)}if(a.nodeInfo.source.downloadURL=c,a.nodeInfo.lastUpdatedAt=Date.now(),a.permissions=b,a.isLocal=!1,e){var g=globalObject.globals.crm.crmById[d].path;return{node:a,path:g,oldNodeId:d}}return{node:a}},Updating._deduceLaunchmode=function(a,b){return CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_LaunchMode")?CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_LaunchMode"):0===b.length?0:2},Updating._createUserscriptTriggers=function(a){var b=[],c=(a.includes||[]).concat(a.include);c&&(b=b.concat(c.map(function(a){return{url:a,not:!1}}).filter(function(a){return!!a.url})));var d=a.match;d&&(b=b.concat(d.map(function(a){return{url:a,not:!1}}).filter(function(a){return!!a.url})));var e=a.exclude;return e&&(b=b.concat(e.map(function(a){return{url:a,not:!1}}).filter(function(a){return!!a.url}))),b=b.filter(function(a,c){return b.indexOf(a)===c}),{triggers:b,launchMode:this._deduceLaunchmode(a,b)}},Updating._createUserscriptScriptData=function(a,b,c){c.type="script",c=c;var d=[];a.CRM_libraries&&a.CRM_libraries.forEach(function(a){try{d.push(JSON.parse(a))}catch(a){}}),a.CRM_libraries=d;for(var e=a.require||[],f=[],g=0;g<e.length;g++){for(var h=!1,i=0;i<d.length;i++)if(d[i].url===e[g]){h=!0;break}h||f.push({url:e[g],name:null})}f.forEach(function(a){Resources.Anonymous.handle({type:"register",name:a.url,url:a.url,scriptId:c.id})}),d=d.concat(f),c.value=globalObject.globals.constants.templates.getDefaultScriptValue({script:b,libraries:d})},Updating._createUserscriptStylesheetData=function(a,b,c){c=c,c.type="stylesheet",c.value={stylesheet:b,defaultOn:a.CRM_defaultOn=CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_defaultOn")||!1,toggle:a.CRM_toggle=CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_toggle")||!1,launchMode:1,options:{},convertedStylesheet:null}},Updating._createUserscriptTypeData=function(a,b,c){CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_stylesheet")?this._createUserscriptStylesheetData(a,b,c):this._createUserscriptScriptData(a,b,c)},Updating.install=function(a){var b=JSON.parse(JSON.stringify(globalObject.globals.storages.settingsStorage.crm)),c=CRM.Script.Updating.installUserscript(a.metaTags,a.script,a.downloadURL,a.allowedPermissions);if(c.path){var d=c.path;this._removeOldNode(c.oldNodeId),this._registerNode(c.node,d)}else this._registerNode(c.node);Storages.uploadChanges("settings",[{key:"crm",oldValue:b,newValue:globalObject.globals.storages.settingsStorage.crm}])},Updating.installUserscript=function(a,b,c,d,e){var f={},g=!1;void 0!==e&&null!==e?(g=!0,f.id=e):f.id=Helpers.generateItemId(),f.name=CRM.Script.MetaTags.getlastMetaTagValue(a,"name")||"name",this._createUserscriptTypeData(a,b,f);var h=this._createUserscriptTriggers(a),i=h.launchMode,j=h.triggers;f.triggers=j,f.value.launchMode=i;var k=CRM.Script.MetaTags.getlastMetaTagValue(a,"updateURL")||CRM.Script.MetaTags.getlastMetaTagValue(a,"downloadURL")||c,l=[];if(a.grant&&(l=a.grant,l=l.splice(l.indexOf("none"),1)),f.nodeInfo={version:CRM.Script.MetaTags.getlastMetaTagValue(a,"version")||null,source:{updateURL:k||c,url:k||CRM.Script.MetaTags.getlastMetaTagValue(a,"namespace")||c,author:CRM.Script.MetaTags.getlastMetaTagValue(a,"author")||"Anonymous"},isRoot:!0,permissions:l,lastUpdatedAt:Date.now(),installDate:(new Date).toLocaleDateString()},g&&(f.nodeInfo.installDate=globalObject.globals.crm.crmById[e]&&globalObject.globals.crm.crmById[e].nodeInfo&&globalObject.globals.crm.crmById[e].nodeInfo.installDate||f.nodeInfo.installDate),CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_contentTypes"))try{f.onContentTypes=JSON.parse(CRM.Script.MetaTags.getlastMetaTagValue(a,"CRM_contentTypes"))}catch(a){}if(f.onContentTypes||(f.onContentTypes=[!0,!0,!0,!0,!0,!0]),f.permissions=d||[],a.resource){var m=a.resource;m.forEach(function(a){var b=a.split(/(\s*)/),c=b[0],d=b[1];Resources.Resource.handle({type:"register",name:c,url:d,scriptId:f.id})})}if(chrome.storage.local.get("requestPermissions",function(a){chrome.permissions.getAll(function(b){var c=b.permissions||[],d=a.requestPermissions||[];d=d.concat(f.permissions.filter(function(a){return c.indexOf(a)===-1})),d=d.filter(function(a,b){return d.indexOf(a)===b}),chrome.storage.local.set({requestPermissions:d},function(){d.length>0&&chrome.runtime.openOptionsPage()})})}),f="script"===f.type?globalObject.globals.constants.templates.getDefaultScriptNode(f):globalObject.globals.constants.templates.getDefaultStylesheetNode(f),g){var n=globalObject.globals.crm.crmById[e].path;return{node:f,path:n,oldNodeId:e}}return{node:f,path:null,oldNodeId:null}},Updating.updateScripts=function(a){function b(){var b=d.map(function(a){var b=globalObject.globals.crm.crmById[a.oldNodeId];return{name:a.node.name,id:a.node.id,oldVersion:b&&b.nodeInfo&&b.nodeInfo.version||void 0,newVersion:a.node.nodeInfo.version}});d.forEach(function(a){a.path?(f._removeOldNode(a.oldNodeId),f._registerNode(a.node,a.path)):f._registerNode(a.node)}),Storages.uploadChanges("settings",[{key:"crm",oldValue:e,newValue:globalObject.globals.storages.settingsStorage.crm}]),chrome.storage.local.get("updatedScripts",function(a){var c=a.updatedScripts||[];c=c.concat(b),chrome.storage.local.set({updatedScripts:c})}),a&&a(b)}var c=[],d=[],e=JSON.parse(JSON.stringify(globalObject.globals.storages.settingsStorage.crm)),f=this;console.log("Looking for updated scripts...");for(var g in globalObject.globals.crm.crmById)if(globalObject.globals.crm.crmById.hasOwnProperty(g)){var h=globalObject.globals.crm.crmById[g],i=h.nodeInfo&&h.nodeInfo.isRoot,j=h.nodeInfo&&h.nodeInfo.source&&"string"!=typeof h.nodeInfo.source&&(h.nodeInfo.source.downloadURL||h.nodeInfo.source.updateURL||h.nodeInfo.source.url);if(j&&i){var k=c.length;c[k]=!0,this._checkNodeForUpdate(h,c,k,j,b,d)}}},Updating._checkNodeForUpdate=function(a,b,c,d,e,f){var g=this;if(void 0!==this._getURL(d).hostname||"script"!==a.type&&"stylesheet"!==a.type&&"menu"!==a.type){if(("script"===a.type||"stylesheet"===a.type)&&d&&Helpers.endsWith(d,".user.js"))try{Helpers.convertFileToDataURI(d,function(h,i){try{var j=CRM.Script.MetaTags.getMetaTags(i);Helpers.isNewer(j.version[0],a.nodeInfo.version)&&(Helpers.compareArray(a.nodeInfo.permissions,j.grant)||0===j.grant.length&&"none"===j.grant[0]||chrome.storage.local.get("addedPermissions",function(b){var c=b.addedPermissions||[];c.push({node:a.id,permissions:j.grant.filter(function(b){return a.nodeInfo.permissions.indexOf(b)===-1})}),chrome.storage.local.set({addedPermissions:c}),chrome.runtime.openOptionsPage()}),f.push(g.installUserscript(j,i,d,a.permissions,a.id))),b[c]=!1,0===b.filter(function(a){return a}).length&&e()}catch(b){console.log("Tried to update script ",a.id," ",a.name," but could not reach download URL")}},function(){b[c]=!1,0===b.filter(function(a){return a}).length&&e()})}catch(b){console.log("Tried to update script ",a.id," ",a.name," but could not reach download URL")}}else try{Helpers.convertFileToDataURI("example.com/isUpdated/"+d.split("/").pop().split(".user.js")[0]+"/"+a.nodeInfo.version,function(h,i){try{var j=JSON.parse(i);j.updated&&(Helpers.compareArray(a.nodeInfo.permissions,j.metaTags.grant)||0===j.metaTags.grant.length&&"none"===j.metaTags.grant[0]||chrome.storage.local.get("addedPermissions",function(b){var c=b.addedPermissions||[];c.push({node:a.id,permissions:j.metaTags.grant.filter(function(b){return a.nodeInfo.permissions.indexOf(b)===-1})}),chrome.storage.local.set({addedPermissions:c}),chrome.runtime.openOptionsPage()}),f.push(g._updateCRMNode(j.node,a.nodeInfo.permissions,d,a.id))),b[c]=!1,0===b.filter(function(a){return a}).length&&e()}catch(b){console.log("Tried to update script ",a.id," ",a.name," but could not reach download URL")}},function(){b[c]=!1,0===b.filter(function(a){return a}).length&&e()})}catch(b){console.log("Tried to update script ",a.id," ",a.name," but could not reach download URL")}},Updating}(),_c.MetaTags=function(){function a(){}return a.getMetaIndexes=function(a){for(var b=-1,c=-1,d=a.split("\n"),e=0;e<d.length;e++)if(b!==-1){if(d[e].indexOf("==/UserScript==")>-1){c=e;break}}else d[e].indexOf("==UserScript==")>-1&&(b=e);return{start:b,end:c}},a.getMetaLines=function(a){var b=this.getMetaIndexes(a),c=b.start,d=b.end,e=c+1,f=a.split("\n");return f.splice(e,d-e)},a.getMetaTags=function(a){for(var b=this.getMetaLines(a),c={},d=/@(\w+)(\s+)(.+)/,e=0;e<b.length;e++){var f=b[e].match(d);f&&(c[f[1]]=c[f[1]]||[],c[f[1]].push(f[3]))}return c},a.getlastMetaTagValue=function(a,b){return a[b]&&a[b][a[b].length-1]},a}(),_c.Background=function(){function a(){}return a._loadBackgroundPageLibs=function(a){for(var b=[],c=[],d=0;d<a.value.libraries.length;d++){var e=void 0;if(globalObject.globals.storages.storageLocal.libraries)for(var f=0;f<globalObject.globals.storages.storageLocal.libraries.length;f++){if(globalObject.globals.storages.storageLocal.libraries[f].name===a.value.libraries[d].name){e=globalObject.globals.storages.storageLocal.libraries[f];break}null===a.value.libraries[d].name&&globalObject.globals.storages.urlDataPairs[a.value.libraries[d].url]&&(e={code:globalObject.globals.storages.urlDataPairs[a.value.libraries[d].url].dataString})}e&&(e.location?b.push("/js/defaultLibraries/"+e.location):c.push(e.code))}return{libraries:b,code:c}},a._genCode=function(a,b){var c=b.key,d=b.node,e=b.script,f=b.safeNode,g=b.indentUnit,h=b.nodeStorage,i=b.greaseMonkeyData,j=d.value.script.indexOf("/*execute locally*/")>-1&&d.isLocal,k=globalObject.globals.storages.storageLocal.catchErrors;return[a.join("\n"),["var crmAPI = new CrmAPIInit("+[f,d.id,{id:0},{},c,h,i,!0,d.value&&d.value.options||{},j,0,chrome.runtime.id].map(function(a){return void 0===a?JSON.stringify(null):JSON.stringify(a)}).join(", ")+");"].join(", "),globalObject.globals.constants.templates.globalObjectWrapperCode("self","selfWrapper",void 0),""+(k?"try {":""),"function main(crmAPI, self, menuitemid, parentmenuitemid, mediatype,"+(g+"linkurl, srcurl, pageurl, frameurl, frameid,")+(g+"selectiontext, editable, waschecked, checked) {"),e,"}","main(crmAPI, selfWrapper);",""+(k?["} catch (error) {",g+"if (crmAPI.debugOnError) {",""+g+g+"debugger;",g+"}",g+"throw error;","}"].join("\n"):"")].join("\n")},a.createBackgroundPage=function(a){if(a&&"script"===a.type&&a.value.backgroundScript&&""!==a.value.backgroundScript){var b=!1;globalObject.globals.background.byId[a.id]&&(b=!0,Logging.backgroundPageLog(a.id,null,"Restarting background page..."),globalObject.globals.background.byId[a.id].worker.terminate(),Logging.backgroundPageLog(a.id,null,"Terminated background page..."));var c=this._loadBackgroundPageLibs(a),d=c.code,e=c.libraries,f=[],g=!1;try{f=Helpers.createSecretKey()}catch(a){g=a}if(g)throw console.log("An error occurred while setting up the script for node ",a.id,g),g;var h=globalObject.globals.storages.nodeStorage,i=h[a.id],j=globalObject.globals.storages.settingsStorage.editor;h[a.id]=h[a.id]||{},_c.Handler.genTabData(0,f,a.id,a.value.backgroundScript),Logging.Listeners.updateTabAndIdLists();var k=CRM.Script.MetaTags.getMetaTags(a.value.script),l=_c.Handler.getInExcludes(a),m=l.excludes,n=l.includes,o=j.useTabs?"\t":Helpers.leftPad(" ",j.tabSize||2),p=a.value.backgroundScript.split("\n").map(function(a){return o+a}).join("\n"),q=_c.Handler.generateGreaseMonkeyData(k,a,n,m,{incognito:!1}),r=CRM.makeSafe(a);r.permissions=a.permissions;var s=this._genCode(d,{key:f,node:a,script:p,safeNode:r,indentUnit:o,nodeStorage:i,greaseMonkeyData:q});sandboxes.sandbox(a.id,s,e,f,function(){var b=[],c=globalObject.globals.crmValues.nodeInstances[a.id],d=function(d){if(c.hasOwnProperty(d)&&c[d])try{globalObject.globals.crmValues.tabData[d].nodes[a.id].forEach(function(a,c){a.port.postMessage({messageType:"dummy"}),b.push({id:d,tabIndex:c})})}catch(a){delete c[d]}};for(var e in c)d(e);return b},function(c){globalObject.globals.background.workers.push(c),globalObject.globals.background.byId[a.id]=c,b&&Logging.log(a.id,"*","Background page ["+a.id+"]: ","Restarted background page...")})}},a.createBackgroundPages=function(){for(var a in globalObject.globals.crm.crmById)if(globalObject.globals.crm.crmById.hasOwnProperty(a)){var b=globalObject.globals.crm.crmById[a];"script"===b.type&&this.createBackgroundPage(b)}},a}(),_c.Handler=function(){function a(){}return a._genCode=function(a,b){var c=a.tab,d=a.key,e=a.info,f=a.node,g=a.safeNode,h=b[0],i=b[1],j=i[0],k=i[1],l=i[2],m=i[3],n=(i[4],i[5]),o=f.value.script.indexOf("/*execute locally*/")>-1&&f.isLocal,p=globalObject.globals.storages.storageLocal.catchErrors;return[["var crmAPI = new CrmAPIInit("+[g,f.id,c,e,d,j,h,k,!1,f.value&&f.value.options||{},o,n,chrome.runtime.id].map(function(a){return void 0===a?JSON.stringify(null):JSON.stringify(a)}).join(", ")+");window.CrmAPIInit = null;"].join(", "),globalObject.globals.constants.templates.globalObjectWrapperCode("window","windowWrapper",f.isLocal?"chrome":"void 0"),""+(p?"try {":""),"function main(crmAPI, window, chrome, menuitemid, parentmenuitemid, mediatype,linkurl, srcurl, pageurl, frameurl, frameid,selectiontext, editable, waschecked, checked) {",l,"}","main.apply(this, [crmAPI, windowWrapper, "+(f.isLocal?"chrome":"void 0")+"].concat("+JSON.stringify([e.menuItemId,e.parentMenuItemId,e.mediaType,e.linkUrl,e.srcUrl,e.pageUrl,e.frameUrl,e.frameId,e.selectionText,e.editable,e.wasChecked,e.checked])+"))",""+(p?["} catch (error) {",m+"if (crmAPI.debugOnError) {",""+m+m+"debugger;",m+"}",m+"throw error;","}"].join("\n"):"")].join("\n");
},a._getScriptsToRun=function(a,b,c,d){for(var e=[],f=0;f<c.value.libraries.length;f++){var g=void 0,h=globalObject.globals.storages.storageLocal.libraries;if(h)for(var i=0;i<h.length;i++)if(h[i].name===c.value.libraries[f].name){g=h[i];break}g||c.value.libraries[f].name||globalObject.globals.storages.urlDataPairs[c.value.libraries[f].url]&&(g={code:globalObject.globals.storages.urlDataPairs[c.value.libraries[f].url].dataString}),g&&e.push({code:g.code,runAt:b})}return d||e.push({file:"/js/crmapi.js",runAt:b}),e.push({code:a,runAt:b}),e},a.generateGreaseMonkeyData=function(a,b,c,d,e){var f=(CRM.Script.MetaTags.getMetaLines(b.value.script)||[]).join("\n"),g=CRM.Script._generateMetaAccessFunction(a);return{info:{script:{author:g("author")||"",copyright:g("copyright"),description:g("description"),excludes:a.excludes,homepage:g("homepage"),icon:g("icon"),icon64:g("icon64"),includes:(a.includes||[]).concat(a.include),lastUpdated:0,matches:a.matches,isIncognito:e.incognito,downloadMode:"browser",name:b.name,namespace:g("namespace"),options:{awareOfChrome:!0,compat_arrayleft:!1,compat_foreach:!1,compat_forvarin:!1,compat_metadata:!1,compat_prototypes:!1,compat_uW_gmonkey:!1,noframes:g("noframes"),override:{excludes:!0,includes:!0,orig_excludes:a.excludes,orig_includes:(a.includes||[]).concat(a.include),use_excludes:d,use_includes:c}},position:1,resources:CRM.Script._getResourcesArrayForScript(b.id),"run-at":a["run-at"]||"document_end",system:!1,unwrap:!0,version:g("version")},scriptMetaStr:f,scriptSource:b.value.script,scriptUpdateURL:g("updateURL"),scriptWillUpdate:!0,scriptHandler:"Custom Right-Click Menu",version:chrome.runtime.getManifest().version},resources:globalObject.globals.storages.resources[b.id]||{}}},a.getInExcludes=function(a){var b=[],c=[];if(a.triggers)for(var d=0;d<a.triggers.length;d++)a.triggers[d].not?b.push(a.triggers[d].url):c.push(a.triggers[d].url);return{excludes:b,includes:c}},a.genTabData=function(a,b,c,d){globalObject.globals.crmValues.tabData[a]=globalObject.globals.crmValues.tabData[a]||{libraries:{},nodes:{}},globalObject.globals.crmValues.tabData[a].nodes[c]=globalObject.globals.crmValues.tabData[a].nodes[c]||[],globalObject.globals.crmValues.tabData[a].nodes[c].push({secretKey:b,usesLocalStorage:d.indexOf("localStorageProxy")>-1})},a.createHandler=function(a){var b=this;return function(c,d,e){void 0===e&&(e=!1);var f=[],g=!1;try{f=Helpers.createSecretKey()}catch(a){g=a}g?chrome.tabs.executeScript(d.id,{code:'alert("Something went wrong very badly, please go to your Custom Right-Click Menu options page and remove any sketchy scripts.")'},function(){chrome.runtime.reload()}):Promiselike.all([new Promiselike(function(a){e?a(null):chrome.tabs.sendMessage(d.id,{type:"getLastClickInfo"},function(b){a(b)})}),new Promiselike(function(c){var e=globalObject.globals.storages.nodeStorage,g=e[a.id],h=globalObject.globals.storages.settingsStorage.editor;b.genTabData(d.id,f,a.id,a.value.script),e[a.id]=e[a.id]||{};var i=globalObject.globals.crmValues.tabData[d.id].nodes[a.id].length-1;Logging.Listeners.updateTabAndIdLists();var j=CRM.Script.MetaTags.getMetaTags(a.value.script),k=j["run-at"]||"document_end",l=b.getInExcludes(a),m=l.excludes,n=l.includes,o=b.generateGreaseMonkeyData(j,a,n,m,d),p=h.useTabs?"\t":Helpers.leftPad(" ",h.tabSize||2),q=a.value.script.split("\n").map(function(a){return p+a}).join("\n");c([g,o,q,p,k,i])})]).then(function(e){var g=CRM.makeSafe(a);g.permissions=a.permissions;var h=b._genCode({node:a,safeNode:g,tab:d,info:c,key:f},e),i=a.value.script.indexOf("unsafeWindow")>-1,j=b._getScriptsToRun(h,e[1][4],a,i);_c._executeScripts(d.id,j,i)})}},a}(),_c),CRM.Link=function(){function a(){}return a._sanitizeUrl=function(a){return a.indexOf("://")===-1&&(a="http://"+a),a},a.createHandler=function(a){var b=this;return function(c,d){for(var e,f=0;f<a.value.length;f++)a.value[f].newTab?chrome.tabs.create({windowId:d.windowId,url:b._sanitizeUrl(a.value[f].url),openerTabId:d.id}):e=a.value[f].url;e&&chrome.tabs.update(d.id,{url:b._sanitizeUrl(e)})}},a}(),CRM.Stylesheet=(_d=function(){function a(){}return a.createToggleHandler=function(a){var b=this;return function(c,d){var e,f=a.id+""+d.id;if(c.wasChecked)e=['var nodes = Array.prototype.slice.apply(document.querySelectorAll(".styleNodes'+f+'")).forEach(function(node){',"node.remove();","});"].join("");else{var g=b._Options.getConvertedStylesheet(a).replace(/[ |\n]/g,"");e=['var CRMSSInsert=document.createElement("style");','CRMSSInsert.className="styleNodes'+f+'";','CRMSSInsert.type="text/css";',"CRMSSInsert.appendChild(document.createTextNode("+JSON.stringify(g)+"));","document.head.appendChild(CRMSSInsert);"].join("")}globalObject.globals.crmValues.stylesheetNodeStatusses[a.id][d.id]=c.checked,chrome.tabs.executeScript(d.id,{code:e,allFrames:!0})}},a.createClickHandler=function(a){var b=this;return function(c,d){var e=a.id+""+d.id,f=b._Options.getConvertedStylesheet(a).replace(/[ |\n]/g,""),g=["(function() {",'if (document.querySelector(".styleNodes'+e+'")) {',"return false;","}",'var CRMSSInsert=document.createElement("style");','CRMSSInsert.classList.add("styleNodes'+e+'");','CRMSSInsert.type="text/css";',"CRMSSInsert.appendChild(document.createTextNode("+JSON.stringify(f)+"));","document.head.appendChild(CRMSSInsert);","}());"].join("");return chrome.tabs.executeScript(d.id,{code:g,allFrames:!0}),a.value.stylesheet}},a}(),_d.Installing=function(){function a(){}return a._triggerify=function(a){var b=/((http|https|file|ftp):\/\/)?(www\.)?((\w+)\.)*((\w+)?|(\w+)?(\/(.*)))?/g.exec(a);return[b[2]||"*","://",b[4]&&b[6]?b[4]+b[6]:"*",b[7]||"/"].join("")},a._extractStylesheetData=function(a){var b=this;if(0===a.domains.length&&0===a.regexps.length&&a.urlPrefixes.length&&0===a.urls.length)return{launchMode:1,triggers:[],code:a.code};var c=[];return a.domains.forEach(function(a){c.push("*://"+a+"/*")}),a.regexps.forEach(function(a){var b=/((http|https|file|ftp):\/\/)?(www\.)?((\w+)\.)*((\w+)?|(\w+)?(\/(.*)))?/g.exec(a);c.push([b[2]?b[2].indexOf("*")>-1?"*":b[2]:"*","://",b[4]&&b[6]?b[4].indexOf("*")>-1||b[6].indexOf("*")>-1?"*":b[4]+b[6]:"*",b[7]?b[7].indexOf("*")>-1?"*":b[7]:"*"].join(""))}),a.urlPrefixes.forEach(function(a){URLParsing.triggerMatchesScheme(a)?c.push(a+"*"):c.push(b._triggerify(a+"*"))}),a.urls.forEach(function(a){URLParsing.triggerMatchesScheme(a)?c.push(a):c.push(b._triggerify(a))}),{launchMode:2,triggers:c.map(function(a){return{url:a,not:!1}}),code:a.code}},a.installStylesheet=function(a){var b=this,c=JSON.parse(a.code);c.sections.forEach(function(d){var e=b._extractStylesheetData(d),f=globalObject.globals.constants.templates.getDefaultStylesheetNode({isLocal:!1,name:c.name,nodeInfo:{version:"1",source:{updateURL:c.updateUrl,url:c.url,author:a.author},permissions:[],installDate:(new Date).toLocaleDateString()},triggers:e.triggers,value:{launchMode:e.launchMode,stylesheet:e.code},id:Helpers.generateItemId()}),g=new CRMFunction(null,"null");g.moveNode(f,{},null)})},a}(),_d._Options=(_e=function(){function a(){}return a._splitComments=function(a){for(var b=[{isComment:!1,line:""}],c=!1,d=0,e=0;e<a.length;e++)"/"===a[e]&&"*"===a[e+1]?(c=!0,d++,e+=1,b[d]={isComment:!0,line:""}):"*"===a[e]&&"/"===a[e+1]?(c=!1,d++,e+=1,b[d]={isComment:!1,line:""}):b[d].line+=a[e];return b},a._evalOperator=function(a,b,c){switch(b){case"<=":return a<=c;case">=":return a>=c;case"<":return a<c;case">":return a>c;case"!==":return a!==c;case"!=":return a!=c;case"===":return a===c;case"==":return a==c}return!1},a._getOptionValue=function(a){switch(a.type){case"array":return a.items;case"boolean":case"number":case"string":return a.value;case"choice":return a.values[a.selected]}},a._getStringExprValue=function(a,b){return"true"===a||"false"!==a&&(this._numRegex.exec(a)?parseFloat(a):this._strRegex.exec(a)?a.slice(1,-1):b[a]?this._getOptionValue(b[a]):void 0)},a._evaluateBoolExpr=function(a,b){if(a.indexOf("||")>-1)return this._evaluateBoolExpr(a.slice(0,a.indexOf("||")),b)||this._evaluateBoolExpr(a.slice(a.indexOf("||")+2),b);if(a.indexOf("&&")>-1)return this._evaluateBoolExpr(a.slice(0,a.indexOf("&&")),b)&&this._evaluateBoolExpr(a.slice(a.indexOf("&&")+2),b);var c=this._boolExprRegex.exec(a);if(c){var d=c[2],e=c[12],f=c[14];return this._evalOperator(this._getStringExprValue(d,b),e,this._getStringExprValue(f,b))}var g=this._valueRegex.exec(a);return!!g&&!!this._getStringExprValue(g[2],b)},a._evaluateIfStatement=function(a,b){var c=this._ifRegex.exec(a)[2];return this._evaluateBoolExpr(c,b)},a._replaceVariableInstances=function(a,b){for(var c=this,d=[{isVariable:!1,content:""}],e=!1,f=0;f<a.length;f++)"{"===a[f]&&"{"===a[f+1]?(e?d[d.length-1].content+="{{":(e=!0,d.push({isVariable:!0,content:""})),f+=1):"}"===a[f]&&"}"===a[f+1]?(e?(e=!1,d.push({isVariable:!1,content:""})):d[d.length-1].content+="}}",f+=1):d[d.length-1].content+=a[f];return d.map(function(a){return a.isVariable?b[a.content]&&c._getOptionValue(b[a.content]):a.content}).join("")},a._getLastIf=function(a){return a.length>0?a[a.length-1]:{skip:!1,isElse:!1,ignore:!1}},a._convertStylesheet=function(a,b){for(var c=this._splitComments(a),d=[],e=[],f=0;f<c.length;f++)this._ifRegex.exec(c[f].line)?e.push({skip:this._getLastIf(e).skip||!this._evaluateIfStatement(c[f].line,b),isElse:!1,ignore:this._getLastIf(e).skip}):this._elseRegex.exec(c[f].line)?(this._getLastIf(e).isElse||this._getLastIf(e).ignore||(this._getLastIf(e).skip=!this._getLastIf(e).skip),this._getLastIf(e).isElse=!0):this._endifRegex.exec(c[f].line)?e.pop():this._getLastIf(e).skip||(c[f].isComment&&this._variableRegex.exec(c[f].line)?d.push(this._replaceVariableInstances(c[f].line,b)):d.push(c[f].line));return d.join("")},a.getConvertedStylesheet=function(a){return a.value.convertedStylesheet&&a.value.convertedStylesheet.options===JSON.stringify(a.value.options)?a.value.convertedStylesheet.stylesheet:(a.value.convertedStylesheet={options:JSON.stringify(a.value.options),stylesheet:this._convertStylesheet(a.value.stylesheet,"string"==typeof a.value.options?{}:a.value.options)},a.value.convertedStylesheet.stylesheet)},a}(),_e._numRegex=/^(-)?(\d)+(\.(\d)+)?$/,_e._strRegex=/^("(.*)"|'(.*)'|`(.*)`)$/,_e._valueRegex=/^(\n|\r|\s)*("(.*)"|'(.*)'|`(.*)`|(-)?(\d)+(\.(\d)+)?|\w(\w|\d)*)(\n|\r|\s)*$/,_e._boolExprRegex=/^(\n|\r|\s)*("(.*)"|'(.*)'|`(.*)`|(-)?(\d)+(\.(\d)+)?|\w(\w|\d)*)(\n|\r|\s)*(<=|>=|<|>|!==|!=|===|==)(\n|\r|\s)*("(.*)"|'(.*)'|`(.*)`|(-)?(\d)+|\w(\w|\d)*)(\n|\r|\s)*$/,_e._ifRegex=/^(\n|\r|\s)*if (.+) then(\n|\r|\s)*$/,_e._elseRegex=/^(\n|\r|\s)*else(\n|\r|\s)*$/,_e._endifRegex=/^(\n|\r|\s)*endif(\n|\r|\s)*$/,_e._variableRegex=/^(\n|\r|\s)*(\w|-)+:(\n|\r|\s)*(.*)\{\{\w(\w|\d)*\}\}(.*)((\n|\r|\s)*,(\n|\r|\s)*(.*)\{\{\w(\w|\d)*\}\}(.*))*$/,_e),_d),CRM.NodeCreation=function(){function a(){}return a._getStylesheetReplacementTabs=function(a){var b=[],c=globalObject.globals.crm.crmById[a.id];if(globalObject.globals.crmValues.contextMenuIds[a.id]&&"stylesheet"===c.type&&"stylesheet"===a.type&&c.value.stylesheet!==a.value.stylesheet)for(var d in globalObject.globals.crmValues.stylesheetNodeStatusses[a.id])globalObject.globals.crmValues.stylesheetNodeStatusses.hasOwnProperty(d)&&globalObject.globals.crmValues.stylesheetNodeStatusses[d]&&globalObject.globals.crmValues.stylesheetNodeStatusses[a.id][d]&&"defaultValue"!==d&&b.push({id:d});return b},a._pushToGlobalToExecute=function(a,b){"stylesheet"===a.type&&a.value.toggle&&a.value.defaultOn&&(1===b||0===b?globalObject.globals.toExecuteNodes.always.push(a):2!==b&&3!==b||(globalObject.globals.toExecuteNodes.onUrl[a.id]=a.triggers))},a._handleHideOnPages=function(a,b,c){if(a.showOnSpecified&&("link"===a.type||"divider"===a.type||"menu"===a.type)||3===b){c.documentUrlPatterns=[],globalObject.globals.crmValues.hideNodesOnPagesData[a.id]=[];for(var d=0;d<a.triggers.length;d++){var e=URLParsing.prepareTrigger(a.triggers[d].url);e&&(a.triggers[d].not?globalObject.globals.crmValues.hideNodesOnPagesData[a.id].push({not:!1,url:e}):c.documentUrlPatterns.push(e))}}},a._generateClickHandler=function(a,b){switch(a.type){case"divider":b.type="separator";break;case"link":b.onclick=CRM.Link.createHandler(a);break;case"script":b.onclick=CRM.Script.Handler.createHandler(a);break;case"stylesheet":a.value.toggle?(b.type="checkbox",b.onclick=CRM.Stylesheet.createToggleHandler(a),b.checked=a.value.defaultOn):b.onclick=CRM.Stylesheet.createClickHandler(a),globalObject.globals.crmValues.stylesheetNodeStatusses[a.id]={defaultValue:a.value.defaultOn}}},a._generateContextMenuItem=function(a,b){b.id=chrome.contextMenus.create(a,function(){chrome.runtime.lastError&&(a.documentUrlPatterns?(console.log("An error occurred with your context menu, attempting again with no url matching.",chrome.runtime.lastError),delete a.documentUrlPatterns,b.id=chrome.contextMenus.create(a,function(){b.id=chrome.contextMenus.create({title:"ERROR",onclick:CRM._createOptionsPageHandler()}),console.log("Another error occured with your context menu!",chrome.runtime.lastError)})):console.log("An error occured with your context menu!",chrome.runtime.lastError))})},a._addRightClickItemClick=function(a,b,c,d){this._pushToGlobalToExecute(a,b),this._handleHideOnPages(a,b,c),this._generateClickHandler(a,c),this._generateContextMenuItem(c,d),globalObject.globals.crmValues.contextMenuInfoById[d.id]={settings:c,path:a.path,enabled:!1}},a._setLaunchModeData=function(a,b,c){var d=("script"===a.type||"stylesheet"===a.type)&&a.value.launchMode||0;1===d?globalObject.globals.toExecuteNodes.always.push(a):2===d?globalObject.globals.toExecuteNodes.onUrl[a.id]=a.triggers:4!==d&&this._addRightClickItemClick(a,d,b,c)},a.createNode=function(a,b){var c=this._getStylesheetReplacementTabs(a),d={title:a.name,contexts:CRM.getContexts(a.onContentTypes),parentId:b},e={id:null};this._setLaunchModeData(a,d,e);var f=e.id;if(0!==c.length){a=a;for(var g=0;g<c.length;g++){var h=a.id+""+c[g].id,i='var nodes = document.querySelectorAll(".styleNodes'+h+'");var i;for (i = 0; i < nodes.length; i++) {nodes[i].remove();}',j=a.value.stylesheet.replace(/[ |\n]/g,"");i+='var CRMSSInsert=document.createElement("style");CRMSSInsert.className="styleNodes'+h+'";CRMSSInsert.type="text/css";CRMSSInsert.appendChild(document.createTextNode('+JSON.stringify(j)+"));document.head.appendChild(CRMSSInsert);",chrome.tabs.executeScript(c[g].id,{code:i,allFrames:!0}),globalObject.globals.crmValues.stylesheetNodeStatusses[a.id][c[g].id]=!0}}return f},a}();var URLParsing=function(){function a(){}return a.triggerMatchesScheme=function(a){var b=/(file:\/\/\/.*|(\*|http|https|file|ftp):\/\/(\*\.[^\/]+|\*|([^\/\*]+.[^\/\*]+))(\/(.*))?|(<all_urls>))/;return b.test(a)},a.prepareTrigger=function(a){if("<all_urls>"===a)return a;if(""===a.replace(/\s/g,""))return null;var b,c=a.split("//");return 1===c.length&&(b="http://"+a,c[1]=c[0]),b=c[1].indexOf("/")===-1?a+"/":a},a.urlMatchesPattern=function(a,b){var c;try{c=this._parsePattern(b)}catch(a){return!1}if("<all_urls>"===c)return!0;var d=c;return this._matchesScheme(a.scheme,d.scheme)&&this._matchesHost(a.host,d.host)&&this._matchesPath(a.path,d.path)},a.validatePatternUrl=function(a){if(!a||"string"!=typeof a)return null;a=a.trim();var b=this._parsePattern(a);if("<all_urls>"===b)return{scheme:"*",host:"*",path:"*"};var c=b;if(c.invalid)return null;if(globalObject.globals.constants.validSchemes.indexOf(c.scheme)===-1)return null;var d=c.host.indexOf("*");if(d>-1){if(c.host.split("*").length>2)return null;if(0!==d||"."!==c.host[1])return null;if(c.host.slice(2).split("/").length>1)return null}return c},a.matchesUrlSchemes=function(a,b){for(var c=!1,d=0;d<a.length;d++){var e=a[d].not,f=a[d].url;if(0===f.indexOf("/")&&Helpers.endsWith(f,"/")){if(new RegExp(f.slice(1,f.length-1)).test(b)){if(e)return!1;c=!0}}else if(new RegExp("^"+f.replace(/\*/g,"(.+)")+"$").test(b)){if(e)return!1;c=!0}}return c},a._parsePattern=function(a){if("<all_urls>"===a)return"<all_urls>";try{var b=a.split("://"),c=b[0],d=b[1],e=d.split("/"),f=e[0],g=e.slice(1);return{scheme:c,host:f,path:g.join("/")}}catch(a){return{scheme:"*",host:"*",path:"*",invalid:!0}}},a._matchesScheme=function(a,b){return"*"===a||a===b},a._matchesHost=function(a,b){if("*"===a)return!0;if("*"===a[0]){var c=a.slice(2),d=b.indexOf(c);return d===b.length-c.length}return a===b},a._matchesPath=function(a,b){var c=a.split("*"),d=c.length,e=d-1;if(0===e)return a===b;if(0!==b.indexOf(c[0]))return!1;b=b.slice(c[0].length);for(var f=1;f<d;f++){if(b.indexOf(c[f])===-1)return!1;b=b.slice(c[f].length)}return!0},a}(),Storages=function(){function a(){}return a.checkBackgroundPagesForChange=function(a,b){void 0===b&&(b=[]),b.forEach(function(a){CRM.Script.Background.createBackgroundPage(globalObject.globals.crm.crmById[a])});for(var c=0;c<a.length;c++)if("crm"===a[c].key){var d={};this._orderBackgroundPagesById(a[c].newValue,d);for(var e in d)if(d.hasOwnProperty(e)){var f=globalObject.globals.crm.crmById[e];"script"!==f.type||f&&f.value.script===d[e]||CRM.Script.Background.createBackgroundPage(f)}}},a.uploadChanges=function(a,b,c){var d=this;switch(void 0===c&&(c=null),a){case"local":chrome.storage.local.set(globalObject.globals.storages.storageLocal);for(var e=0;e<b.length;e++)"useStorageSync"===b[e].key&&this.uploadChanges("settings",[],b[e].newValue);break;case"settings":"settings"===a&&(globalObject.globals.storages.settingsStorage.settingsLastUpdatedAt=(new Date).getTime()),null!==c&&(globalObject.globals.storages.storageLocal.useStorageSync=c);var f=JSON.stringify(globalObject.globals.storages.settingsStorage);if(chrome.storage.local.set({settingsVersionData:{current:{hash:window.md5(f),date:(new Date).getTime()},latest:globalObject.globals.storages.storageLocal.settingsVersionData.latest,wasUpdated:globalObject.globals.storages.storageLocal.settingsVersionData.wasUpdated}}),globalObject.globals.storages.storageLocal.useStorageSync)if(f.length>=101400)chrome.storage.local.set({useStorageSync:!1},function(){d.uploadChanges("settings",b)});else{var g=this.cutData(f);chrome.storage.sync.set(g,function(){chrome.runtime.lastError?(console.log("Error on uploading to chrome.storage.sync ",chrome.runtime.lastError),chrome.storage.local.set({useStorageSync:!1},function(){d.uploadChanges("settings",b)})):(d._changeCRMValuesIfSettingsChanged(b),chrome.storage.local.set({settings:null}))})}else chrome.storage.local.set({settings:globalObject.globals.storages.settingsStorage},function(){chrome.runtime.lastError?console.log("Error on uploading to chrome.storage.local ",chrome.runtime.lastError):d._changeCRMValuesIfSettingsChanged(b)}),chrome.storage.sync.set({indexes:null});break;case"libraries":chrome.storage.local.set({libraries:b})}},a.applyChanges=function(a){switch(a.type){case"optionsPage":a.localChanges&&(this._applyChangeForStorageType(globalObject.globals.storages.storageLocal,a.localChanges),this.uploadChanges("local",a.localChanges)),a.settingsChanges&&(this._applyChangeForStorageType(globalObject.globals.storages.settingsStorage,a.settingsChanges),this.uploadChanges("settings",a.settingsChanges));break;case"libraries":this._applyChangeForStorageType(globalObject.globals.storages.storageLocal,[{key:"libraries",newValue:a.libraries,oldValue:globalObject.globals.storages.storageLocal.libraries}]);break;case"nodeStorage":globalObject.globals.storages.nodeStorage[a.id]=globalObject.globals.storages.nodeStorage[a.id]||{},this._applyChangeForStorageType(globalObject.globals.storages.nodeStorage[a.id],a.nodeStorageChanges),this._notifyNodeStorageChanges(a.id,a.tabId,a.nodeStorageChanges)}},a.setStorages=function(a,b,c,d){globalObject.globals.storages.storageLocal=a,globalObject.globals.storages.settingsStorage=b,globalObject.globals.storages.globalExcludes=this._setIfNotSet(c,"globalExcludes",[]).map(URLParsing.validatePatternUrl).filter(function(a){return null!==a}),globalObject.globals.storages.resources=this._setIfNotSet(c,"resources",[]),globalObject.globals.storages.nodeStorage=this._setIfNotSet(c,"nodeStorage",{}),globalObject.globals.storages.resourceKeys=this._setIfNotSet(c,"resourceKeys",[]),globalObject.globals.storages.urlDataPairs=this._setIfNotSet(c,"urlDataPairs",{}),CRM.updateCRMValues(),d&&d()},a.cutData=function(a){var b={},c=[],d=a.match(/[\s\S]{1,5000}/g);return d.forEach(function(a){var d=c.length,e="section"+d;b[e]=a,c[d]=e}),b.indexes=c,b},a.loadStorages=function(a){var b=this;chrome.storage.sync.get(function(c){chrome.storage.local.get(function(d){var e=b._isFirstTime(d);if("firstTimeCallback"===e.type)e.fn(function(c){b.setStorages(c.storageLocalCopy,c.settingsStorage,c.chromeStorageLocal,a)});else{var f=JSON.parse(JSON.stringify(d));delete f.resources,delete f.nodeStorage,delete f.urlDataPairs,delete f.resourceKeys,delete f.globalExcludes;var g=void 0;if(d.useStorageSync){var h=c.indexes;if(h){var i=[];h.forEach(function(a){i.push(c[a])});var j=i.join("");g=JSON.parse(j)}else chrome.storage.local.set({useStorageSync:!1}),g=d.settings}else if(d.settings)delete f.settings,g=d.settings;else{chrome.storage.local.set({useStorageSync:!0});var h=c.indexes,k=[];h.forEach(function(a){k.push(c[a])});var j=k.join("");g=JSON.parse(j)}b._checkForStorageSyncUpdates(g,d),b.setStorages(f,g,d,a),"upgradeVersion"===e.type&&e.fn()}})})},a._changeCRMValuesIfSettingsChanged=function(b){for(var c=0;c<b.length;c++)"crm"===b[c].key||"showOptions"===b[c].key?(CRM.updateCRMValues(),a.checkBackgroundPagesForChange(b),CRM.buildPageCRM(),MessageHandling.signalNewCRM()):"latestId"===b[c].key&&(globalObject.globals.latestId=b[c].newValue,chrome.runtime.sendMessage({type:"idUpdate",latestId:b[c].newValue}))},a._setIfNotSet=function(a,b,c){return a[b]?a[b]:(chrome.storage.local.set({key:c}),c)},a._applyChangeForStorageType=function(a,b){for(var c=0;c<b.length;c++)a[b[c].key]=b[c].newValue},a._notifyNodeStorageChanges=function(a,b,c){globalObject.globals.crm.crmById[a].storage=globalObject.globals.storages.nodeStorage[a],chrome.storage.local.set({nodeStorage:globalObject.globals.storages.nodeStorage});var d=globalObject.globals.crmValues.tabData;for(var e in d)if(d.hasOwnProperty(e)&&d[e]&&~~e!==b){var f=d[e].nodes;f[a]&&f[a].forEach(function(a){a.port.postMessage({changes:c,messageType:"storageUpdate"})})}},a._orderBackgroundPagesById=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];"script"===d.type?b[d.id]=d.value.backgroundScript:"menu"===d.type&&d.children&&this._orderBackgroundPagesById(d.children,b)}},a.crmForEach=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];b(d),"menu"===d.type&&d.children&&this.crmForEach(d.children,b)}},a._upgradeVersion=function(a,b){var c=this,d={before:[],after:[]};return"2.0.3"===a&&d.after.push(function(){c.crmForEach(globalObject.globals.crm.crmTree,function(a){"script"===a.type&&(a.value.oldScript=a.value.script,a.value.script=c.SetupHandling.TransferFromOld.legacyScriptReplace.chromeCallsReplace.replace(a.value.script,c.SetupHandling.TransferFromOld.legacyScriptReplace.generateScriptUpgradeErrorHandler(a.id))),a.isLocal&&(a.nodeInfo.installDate=(new Date).toLocaleDateString(),a.nodeInfo.lastUpdatedAt=Date.now(),a.nodeInfo.version="1.0",a.nodeInfo.isRoot=!1,a.nodeInfo.source="local",a.onContentTypes[0]&&a.onContentTypes[1]&&a.onContentTypes[2]&&!a.onContentTypes[3]&&!a.onContentTypes[4]&&!a.onContentTypes[5]&&(a.onContentTypes=[!0,!0,!0,!0,!0,!0]))}),CRM.updateCrm()}),"2.0.11"===b&&Helpers.isTamperMonkeyEnabled(function(a){globalObject.globals.storages.storageLocal.useAsUserscriptInstaller=!a,chrome.storage.local.set({useAsUserscriptInstaller:!a})}),chrome.storage.local.set({lastUpdatedAt:b}),d},a._isFirstTime=function(a){var b=chrome.runtime.getManifest().version;if(localStorage.getItem("transferToVersion2")&&a.lastUpdatedAt===b)return{type:"noChanges"};if(localStorage.getItem("transferToVersion2")&&a.lastUpdatedAt){var c=this._upgradeVersion(a.lastUpdatedAt,b);return c.before.forEach(function(a){a()}),{type:"upgradeVersion",fn:function(){c.after.forEach(function(a){a()})}}}if(window.localStorage.getItem("transferToVersion2")||void 0===window.localStorage.getItem("numberofrows")||null===window.localStorage.getItem("numberofrows")){var d=this.SetupHandling.handleFirstRun();return{type:"firstTimeCallback",fn:function(a){d.done?a(d.value):d.onDone=a}}}return{type:"firstTimeCallback",fn:this.SetupHandling.handleTransfer()}},a._checkForStorageSyncUpdates=function(a,b){var c=JSON.stringify(a),d=window.md5(c);b.settingsVersionData&&b.settingsVersionData.current.hash!==d&&chrome.storage.local.set({settingsVersionData:{current:{hash:d,date:a.settingsLastUpdatedAt},latest:{hash:d,date:a.settingsLastUpdatedAt},wasUpdated:!0}})},a}();Storages.SetupHandling=(_f=function(){function a(){}return a._getDefaultStorages=function(a){var b=this._getDefaultSyncStorage(),c=window.md5(JSON.stringify(b));Helpers.isTamperMonkeyEnabled(function(d){a([{requestPermissions:[],editing:null,selectedCrmType:0,jsLintGlobals:["window","$","jQuery","crmAPI"],globalExcludes:[""],useStorageSync:!0,notFirstTime:!0,lastUpdatedAt:chrome.runtime.getManifest().version,authorName:"anonymous",showOptions:!0,recoverUnsavedData:!1,CRMOnPage:~~/Chrome\/([0-9.]+)/.exec(navigator.userAgent)[1].split(".")[0]>34,catchErrors:!0,editCRMInRM:!1,useAsUserscriptInstaller:d,hideToolsRibbon:!1,shrinkTitleRibbon:!1,libraries:[],settingsVersionData:{current:{hash:c,date:(new Date).getTime()},latest:{hash:c,date:(new Date).getTime()},wasUpdated:!1}},b])})},a._getDefaultSyncStorage=function(){return{editor:{keyBindings:{autocomplete:"Ctrl-Space",showType:"Ctrl-I",showDocs:"Ctrl-O",goToDef:"Alt-.",rename:"Ctrl-Q",jumpBack:"Alt-,",selectName:"Ctrl-."},tabSize:4,theme:"dark",useTabs:!0,zoom:"100"},crm:[globalObject.globals.constants.templates.getDefaultLinkNode({id:Helpers.generateItemId(),isLocal:!0})],settingsLastUpdatedAt:(new Date).getTime(),latestId:globalObject.globals.latestId}},a.handleFirstRun=function(a){var b=this;window.localStorage.setItem("transferToVersion2","true");var c={done:!1,onDone:null};return this._getDefaultStorages(function(d){var e=d[0],f=d[1];chrome.storage.local.set(e),b._uploadStorageSyncData(f),a&&(f.crm=a);var g=e,h=JSON.parse(JSON.stringify(e)),i={settingsStorage:f,storageLocalCopy:h,chromeStorageLocal:g};c.value=i,c.onDone?(c.onDone(i),c.done=!0):c.done=!0}),c},a.handleTransfer=function(){var a=this;return window.localStorage.setItem("transferToVersion2","true"),chrome.storage.local.set({isTransfer:!0}),function(b){if(window.CodeMirror.TernServer){var c=a.handleFirstRun(a.TransferFromOld.transferCRMFromOld("true"===window.localStorage.getItem("whatpage")));c.done?b(c.value):c.onDone=b}else window.setTimeout(function(){a.handleTransfer()(function(a){b(a)})},200)}},a._uploadStorageSyncData=function(a){var b=this,c=JSON.stringify(a);if(c.length>=101400)chrome.storage.local.set({useStorageSync:!1},function(){b._uploadStorageSyncData(a)});else{var d=Storages.cutData(c);chrome.storage.sync.set(d,function(){chrome.runtime.lastError?(console.log("Error on uploading to chrome.storage.sync ",chrome.runtime.lastError),chrome.storage.local.set({useStorageSync:!1},function(){b._uploadStorageSyncData(a)})):chrome.storage.local.set({settings:null})})}},a}(),_f.TransferFromOld=(_g=function(){function a(){}return a._backupLocalStorage=function(){if("undefined"!=typeof localStorage&&("undefined"!=typeof window.indexedDB||"undefined"!=typeof window.webkitIndexedDB)){var a=JSON.stringify(localStorage),b=window.indexedDB||window.webkitIndexedDB,c=b.open("localStorageBackup",1);c.onerror=function(){console.log("Error backing up localStorage data")},c.onupgradeneeded=function(b){var c=b.target.result,d=c.createObjectStore("data",{keyPath:"id"});d.add({id:0,data:a})}}},a.transferCRMFromOld=function(a,b,c){void 0===b&&(b=localStorage),void 0===c&&(c=2),this._backupLocalStorage();for(var d=parseInt(b.getItem("numberofrows"),10)+1,e=[],f=1;f<d;f++)e.push(this._parseOldCRMNode(b.getItem(String(f)),a,c));var g=[];return this._assignParents(g,e,{index:0},e.length),g},a._parseOldCRMNode=function(a,b,c){var d,e=a.split("%123"),f=e[0],g=e[1],h=e[2];switch(g.toLowerCase()){case"link":var i=void 0;i=h.indexOf(", ")>-1?h.split(", "):h.split(","),d=globalObject.globals.constants.templates.getDefaultLinkNode({name:f,id:Helpers.generateItemId(),value:i.map(function(a){return{newTab:b,url:a}})});break;case"divider":d=globalObject.globals.constants.templates.getDefaultDividerNode({name:f,id:Helpers.generateItemId(),isLocal:!0});break;case"menu":d=globalObject.globals.constants.templates.getDefaultMenuNode({name:f,id:Helpers.generateItemId(),children:h,isLocal:!0});break;case"script":var j=h.split("%124"),k=j[0],l=j[1],m=void 0,n=k+"";n+""!="0"&&n+""!="2"&&(m=n.split("1,")[1].split(","),m=m.map(function(a){return{not:!1,url:a.trim()}}).filter(function(a){return""!==a.url}),k="2");var o=Helpers.generateItemId();d=globalObject.globals.constants.templates.getDefaultScriptNode({name:f,id:o,value:{launchMode:parseInt(k,10),updateNotice:!0,oldScript:l,script:Storages.SetupHandling.TransferFromOld.legacyScriptReplace.convertScriptFromLegacy(l,o,c)},isLocal:!0}),m&&(d.triggers=m)}return d},a._assignParents=function(a,b,c,d){for(;0!==d&&b[c.index];c.index++,d--){var e=b[c.index];if("menu"===e.type){var f=~~e.children;e.children=[],c.index++,this._assignParents(e.children,b,c,f),c.index--}a.push(e)}},a}(),_g.legacyScriptReplace=(_h=function(){function a(){}return a.generateScriptUpgradeErrorHandler=function(a){return function(b,c,d){chrome.storage.local.get(function(e){if(!e.upgradeErrors){var f={};f[a]={oldScript:b,newScript:c,generalError:d},e.upgradeErrors=f,globalObject.globals.storages.storageLocal.upgradeErrors=f}e.upgradeErrors[a]=globalObject.globals.storages.storageLocal.upgradeErrors[a]={oldScript:b,newScript:c,generalError:d},chrome.storage.local.set({upgradeErrors:e.upgradeErrors})})}},a.convertScriptFromLegacy=function(a,b,c){var d=!1,e=a.indexOf("/*execute locally*/");e!==-1&&(a=a.replace("/*execute locally*/\n",""),e===a.indexOf("/*execute locally*/")&&(a=a.replace("/*execute locally*/","")),d=!0);try{switch(c){case 0:a=this.chromeCallsReplace.replace(a,this.generateScriptUpgradeErrorHandler(b));break;case 1:a=d?this.localStorageReplace.replaceCalls(a.split("\n")):a;break;case 2:var f=d?this.localStorageReplace.replaceCalls(a.split("\n")):a;a=this.chromeCallsReplace.replace(f,this.generateScriptUpgradeErrorHandler(b))}}catch(b){return a}return a},a}(),_h.localStorageReplace=function(){function a(){}return a.findLocalStorageExpression=function(a,b){switch(a.type){case"Identifier":if("localStorage"===a.name)return b.script=b.script.slice(0,a.start)+"localStorageProxy"+b.script.slice(a.end),b.lines=b.script.split("\n"),!0;break;case"VariableDeclaration":for(var c=0;c<a.declarations.length;c++){var d=a.declarations[c];if(d.init&&this.findLocalStorageExpression(d.init,b))return!0}break;case"MemberExpression":return!!this.findLocalStorageExpression(a.object,b)||this.findLocalStorageExpression(a.property,b);case"CallExpression":if(a.arguments&&a.arguments.length>0)for(var c=0;c<a.arguments.length;c++)if(this.findLocalStorageExpression(a.arguments[c],b))return!0;if(a.callee)return this.findLocalStorageExpression(a.callee,b);break;case"AssignmentExpression":return this.findLocalStorageExpression(a.right,b);case"FunctionExpression":case"FunctionDeclaration":for(var c=0;c<a.body.body.length;c++)if(this.findLocalStorageExpression(a.body.body[c],b))return!0;break;case"ExpressionStatement":return this.findLocalStorageExpression(a.expression,b);case"SequenceExpression":for(var c=0;c<a.expressions.length;c++)if(this.findLocalStorageExpression(a.expressions[c],b))return!0;break;case"UnaryExpression":case"ConditionalExpression":return!!this.findLocalStorageExpression(a.consequent,b)||this.findLocalStorageExpression(a.alternate,b);case"IfStatement":if(this.findLocalStorageExpression(a.consequent,b))return!0;if(a.alternate)return this.findLocalStorageExpression(a.alternate,b);break;case"LogicalExpression":case"BinaryExpression":return!!this.findLocalStorageExpression(a.left,b)||this.findLocalStorageExpression(a.right,b);
case"BlockStatement":for(var c=0;c<a.body.length;c++)if(this.findLocalStorageExpression(a.body[c],b))return!0;break;case"ReturnStatement":return this.findLocalStorageExpression(a.argument,b);case"ObjectExpressions":for(var c=0;c<a.properties.length;c++)if(this.findLocalStorageExpression(a.properties[c].value,b))return!0}return!1},a.getLineSeperators=function(a){for(var b=0,c=[],d=0;d<a.length;d++)c.push({start:b,end:b+=a[d].length+1});return c},a.replaceCalls=function(a){var b=new window.TernFile("[doc]");b.text=a.join("\n");var c=new window.CodeMirror.TernServer({defs:[window.ecma5,window.ecma6,window.browserDefs]});window.tern.withContext(c.cx,function(){b.ast=window.tern.parse(b.text,c.passes,{directSourceFile:b,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,ecmaVersion:c.ecmaVersion})});for(var d=b.ast.body,e=b.text,f={lines:a,lineSeperators:this.getLineSeperators(a),script:e},g=0;g<d.length;g++){var h=d[g];if(this.findLocalStorageExpression(h,f))return this.replaceCalls(f.lines)}return f.script},a}(),_h.chromeCallsReplace=function(){function a(){}return a.isProperty=function(a,b){return a===b||a.replace(/['|"|`]/g,"")===b},a.getCallLines=function(a,b,c){for(var d={},e=0;e<a.length;e++){var f=a[e];if(f.start<=b&&(d.from={index:f.start,line:e}),f.end>=c){d.to={index:f.end,line:e};break}}return d},a.getFunctionCallExpressions=function(a){for(var b=a.parentExpressions.length-1,c=a.parentExpressions[b];c&&"CallExpression"!==c.type;)c=a.parentExpressions[--b];return a.parentExpressions[b]},a.getChromeAPI=function(a,b){b.functionCall=b.functionCall.map(function(a){return a.replace(/['|"|`]/g,"")});var c=b.functionCall;c=c.reverse(),"chrome"===c[0]&&c.splice(0,1);var d=a.callee.end,e=a.end,f=b.persistent.script.slice(d,e);return{call:c.join("."),args:f}},a.getLineIndexFromTotalIndex=function(a,b,c){for(var d=0;d<b;d++)c-=a[d].length+1;return c},a.replaceChromeFunction=function(a,b,c){if(!a.isReturn||a.isValidReturn){for(var d,e=a.persistent.lines,f=this.getChromeAPI(b,a),g=a.persistent.lines[c.from.line],h=this.getLineIndexFromTotalIndex(a.persistent.lines,c.from.line,a.returnExpr&&a.returnExpr.start||b.callee.start),i=this.getLineIndexFromTotalIndex(a.persistent.lines,c.from.line,b.callee.end),j=g.slice(0,h)+("window.crmAPI.chrome('"+f.call+"')"),k=null;" "===j[k=j.length-1];)j=j.slice(0,k);if(";"===j[k=j.length-1]&&(j=j.slice(0,k)),"()"!==f.args){var l=f.args.split("\n");for(j+=l[0],d=1;d<l.length;d++)e[c.from.line+d]=l[d]}if(a.isReturn){for(var m=g.slice(i+f.args.split("\n")[0].length);0===m.indexOf(";");)m=m.slice(1);j+=".return(function("+a.returnName+") {"+m;for(var n=!0,o=0,p=0;p<a.persistent.lines.length;p++){if(0===a.persistent.lines[p].indexOf("\t")){n=!0;break}if(0===a.persistent.lines[p].indexOf("  ")){for(var q=a.persistent.lines[p].split(" "),r=0;r<q.length&&" "===q[r];r++)o++;n=!1;break}}var s;n?s="\t":(s=[],s[o]=" ",s=s.join(" "));var t=null,u=null;for(d=a.parentExpressions.length-1;null===t&&0!==d;d--)if("BlockStatement"===a.parentExpressions[d].type||"FunctionExpression"===a.parentExpressions[d].type&&"BlockStatement"===a.parentExpressions[d].body.type){for(t=this.getLineIndexFromTotalIndex(a.persistent.lines,c.from.line,a.parentExpressions[d].end),u=0;t>0;)t=this.getLineIndexFromTotalIndex(a.persistent.lines,c.from.line+ ++u,a.parentExpressions[d].end);t=this.getLineIndexFromTotalIndex(a.persistent.lines,c.from.line+(u-1),a.parentExpressions[d].end)}null===u&&(u=e.length-c.from.line+1);for(var v=0,w=e[c.from.line];0===w.indexOf(s);)w=w.replace(s,""),v++;var x,y=[];y[v]="";var z=y.join(s)+"}).send();",A=a.persistent.lines.length+1;for(d=c.from.line;d<c.from.line+(u-1);d++)e[d]=s+e[d];for(d=c.from.line+(u-1);d<A;d++)x=e[d],e[d]=z,z=x}else e[c.from.line+(d-1)]=e[c.from.line+(d-1)]+".send();",1===d&&(j+=".send();");e[c.from.line]=j}},a.callsChromeFunction=function(a,b,c){if(b.parentExpressions.push(a),a.arguments&&a.arguments.length>0)for(var d=0;d<a.arguments.length;d++)if(this.findChromeExpression(a.arguments[d],this.removeObjLink(b),c))return!0;if("MemberExpression"!==a.type)return this.findChromeExpression(a,this.removeObjLink(b),c);if(a.property&&(b.functionCall=b.functionCall||[],b.functionCall.push(a.property.name||a.property.raw)),a.object&&a.object.name){var e=this.isProperty(a.object.name,"window")&&this.isProperty(a.property.name||a.property.raw,"chrome");if(e||this.isProperty(a.object.name,"chrome")){b.expression=a;var f=this.getFunctionCallExpressions(b),g=this.getCallLines(b.persistent.lineSeperators,f.start,f.end);return b.isReturn&&!b.isValidReturn?(g.from.index=this.getLineIndexFromTotalIndex(b.persistent.lines,g.from.line,g.from.index),g.to.index=this.getLineIndexFromTotalIndex(b.persistent.lines,g.to.line,g.to.index),c(g,b.persistent.passes),!1):(b.persistent.diagnostic||this.replaceChromeFunction(b,f,g),!0)}}else if(a.object)return this.callsChromeFunction(a.object,b,c);return!1},a.removeObjLink=function(a){var b=a.parentExpressions||[],c={};for(var d in a)a.hasOwnProperty(d)&&"parentExpressions"!==d&&"persistent"!==d&&(c[d]=a[d]);for(var e=[],f=0;f<b.length;f++)e.push(b[f]);return c.persistent=a.persistent,c.parentExpressions=e,c},a.findChromeExpression=function(a,b,c){switch(b.parentExpressions=b.parentExpressions||[],b.parentExpressions.push(a),a.type){case"VariableDeclaration":b.isValidReturn=1===a.declarations.length;for(var d=0;d<a.declarations.length;d++){var e=a.declarations[d];if(e.init){var f=this.removeObjLink(b),g=e.id.name;if(f.isReturn=!0,f.returnExpr=a,f.returnName=g,this.findChromeExpression(e.init,f,c))return!0}}break;case"CallExpression":case"MemberExpression":var h=[];if(a.arguments&&a.arguments.length>0)for(var d=0;d<a.arguments.length;d++)if("MemberExpression"!==a.arguments[d].type&&"CallExpression"!==a.arguments[d].type)h.push(a.arguments[d]);else if(this.findChromeExpression(a.arguments[d],this.removeObjLink(b),c))return!0;if(b.functionCall=[],a.callee&&this.callsChromeFunction(a.callee,b,c))return!0;for(var d=0;d<h.length;d++)if(this.findChromeExpression(h[d],this.removeObjLink(b),c))return!0;break;case"AssignmentExpression":return b.isReturn=!0,b.returnExpr=a,b.returnName=a.left.name,this.findChromeExpression(a.right,b,c);case"FunctionExpression":case"FunctionDeclaration":b.isReturn=!1;for(var d=0;d<a.body.body.length;d++)if(this.findChromeExpression(a.body.body[d],this.removeObjLink(b),c))return!0;break;case"ExpressionStatement":return this.findChromeExpression(a.expression,b,c);case"SequenceExpression":b.isReturn=!1;for(var i=a.expressions.length-1,d=0;d<a.expressions.length;d++)if(d===i&&(b.isReturn=!0),this.findChromeExpression(a.expressions[d],this.removeObjLink(b),c))return!0;break;case"UnaryExpression":case"ConditionalExpression":if(b.isValidReturn=!1,b.isReturn=!0,this.findChromeExpression(a.consequent,this.removeObjLink(b),c))return!0;if(this.findChromeExpression(a.alternate,this.removeObjLink(b),c))return!0;break;case"IfStatement":if(b.isReturn=!1,this.findChromeExpression(a.consequent,this.removeObjLink(b),c))return!0;if(a.alternate&&this.findChromeExpression(a.alternate,this.removeObjLink(b),c))return!0;break;case"LogicalExpression":case"BinaryExpression":if(b.isReturn=!0,b.isValidReturn=!1,this.findChromeExpression(a.left,this.removeObjLink(b),c))return!0;if(this.findChromeExpression(a.right,this.removeObjLink(b),c))return!0;break;case"BlockStatement":b.isReturn=!1;for(var d=0;d<a.body.length;d++)if(this.findChromeExpression(a.body[d],this.removeObjLink(b),c))return!0;break;case"ReturnStatement":return b.isReturn=!0,b.returnExpr=a,b.isValidReturn=!1,this.findChromeExpression(a.argument,b,c);case"ObjectExpressions":b.isReturn=!0,b.isValidReturn=!1;for(var d=0;d<a.properties.length;d++)if(this.findChromeExpression(a.properties[d].value,this.removeObjLink(b),c))return!0}return!1},a.generateOnError=function(a){return function(b,c){a[c]?a[c].push(b):a[c]=[b]}},a.replaceChromeCalls=function(a,b,c){var d=new window.TernFile("[doc]");d.text=a.join("\n");var e=new window.CodeMirror.TernServer({defs:[window.ecma5,window.ecma6,window.browserDefs]});window.tern.withContext(e.cx,function(){d.ast=window.tern.parse(d.text,e.passes,{directSourceFile:d,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,ecmaVersion:e.ecmaVersion})});for(var f=d.ast.body,g=0,h=[],i=0;i<a.length;i++)h.push({start:g,end:g+=a[i].length+1});var j,k=d.text,l={lines:a,lineSeperators:h,script:k,passes:b};if(0===b){l.diagnostic=!0;for(var i=0;i<f.length;i++)j=f[i],this.findChromeExpression(j,{persistent:l},c);l.diagnostic=!1}for(var i=0;i<f.length;i++)if(j=f[i],this.findChromeExpression(j,{persistent:l},c)){k=this.replaceChromeCalls(l.lines.join("\n").split("\n"),b+1,c);break}return k},a.removePositionDuplicates=function(a){var b=[];return a.forEach(function(a,c){b[c]=JSON.stringify(a)}),b=b.filter(function(a,c){return b.indexOf(a)===c}),b.map(function(a){return JSON.parse(a)})},a.replace=function(a,b){var c=a.indexOf("/*execute locally*/");c!==-1&&(a=a.replace("/*execute locally*/\n",""),c===a.indexOf("/*execute locally*/")&&(a=a.replace("/*execute locally*/","")));var d=[];try{a=this.replaceChromeCalls(a.split("\n"),0,this.generateOnError(d))}catch(c){return b(null,null,!0),a}var e=d[0],f=d[d.length-1];return f&&b(this.removePositionDuplicates(e),this.removePositionDuplicates(f)),a},a}(),_h),_g),_f),function(){Storages.loadStorages(function(){try{globalObject.globals.latestId=globalObject.globals.storages.settingsStorage.latestId,GlobalDeclarations.refreshPermissions(),GlobalDeclarations.setHandlerFunction(),chrome.runtime.onConnect.addListener(function(a){a.onMessage.addListener(window.createHandlerFunction(a))}),chrome.runtime.onMessage.addListener(MessageHandling.handleRuntimeMessage),CRM.buildPageCRM(),CRM.Script.Background.createBackgroundPages(),GlobalDeclarations.init(),Resources.checkIfResourcesAreUsed(),Resources.updateResourceValues(),CRM.Script.Updating.updateScripts(),window.setInterval(function(){CRM.Script.Updating.updateScripts()},216e5),GlobalDeclarations.initGlobalFunctions(),location.href.indexOf("test")>-1&&(globalObject.Storages=Storages),"undefined"!=typeof module&&(globalObject.TransferFromOld=Storages.SetupHandling.TransferFromOld)}catch(a){throw console.log(a),a}})}();var _a,_b,_c,_d,_e,_f,_g,_h}("undefined"!=typeof module||window.isDev?window:{},function(a){function b(a,b,c,d,e,f){return d.apply(e,f)}return a.sandboxChrome=function(a,c){for(var d={},e=window.chrome,f=a.split("."),g=0;g<f.length;g++)d=e,e=e[f[g]];return b(null,null,null,e,d,c)},a}(function(){var a={},b=function(){function a(a,b,c,d,e){var f=this;this.id=a,this.script=b,this.secretKey=d,this._callbacks=[],this._verified=!1,this.worker=new Worker("/js/sandbox.js");var g=window.createHandlerFunction({postMessage:this._postMessage.bind(this)});this.worker.addEventListener("message",function(b){var c=b.data;switch(c.type){case"handshake":case"crmapi":f._verified||(window.backgroundPageLog(a,null,"Ininitialized background page"),f.worker.postMessage({type:"verify",instances:e()}),f._verified=!0),f._verifyKey(c,g);break;case"log":window.backgroundPageLog.apply(window,[a,[c.lineNo,c.logId]].concat(JSON.parse(c.data)))}f._callbacks&&(f._callbacks.forEach(function(a){a(c)}),f._callbacks=[])},!1),this.worker.postMessage({type:"init",id:a,script:b,libraries:c})}return a.prototype.post=function(a){this.worker.postMessage(a)},a.prototype.listen=function(a){this._callbacks.push(a)},a.prototype._postMessage=function(a){this.worker.postMessage({type:"message",message:JSON.stringify(a),key:this.secretKey.join("")+this.id+"verified"})},a.prototype._verifyKey=function(a,b){a.key.join("")===this.secretKey.join("")?b(JSON.parse(a.data)):window.backgroundPageLog(this.id,null,"Tried to send an unauthenticated message")},a}();return a.sandbox=function(a,c,d,e,f,g){g(new b(a,c,d,e,f))},a}())),"undefined"==typeof module&&console.log('If you\'re here to check out your background script, get its ID (you can type getID("name") to find the ID), and type filter(id, [optional tabId]) to show only those messages. You can also visit the logging page for even better logging over at ',chrome.runtime.getURL("html/logging.html"));