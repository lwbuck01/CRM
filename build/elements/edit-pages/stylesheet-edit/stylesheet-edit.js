/*
 * Original can be found at https://github.com/SanderRonde/CustomRightClickMenu 
 * This code may only be used under the MIT style license found in the LICENSE.txt file 
**/
"use strict";var stylesheetEditProperties={item:{type:Object,value:{},notify:!0}},STE=function(){function a(){}return a.getExportData=function(){$("stylesheet-edit #exportMenu paper-menu")[0].selected=0;var a={};return this.save(null,a),a},a.exportStylesheetAsCRM=function(){window.app.editCRM.exportSingleNode(this.getExportData(),"CRM")},a.exportStylesheetAsUserscript=function(){window.app.editCRM.exportSingleNode(this.getExportData(),"Userscript")},a.exportStylesheetAsUserstyle=function(){window.app.editCRM.exportSingleNode(this.getExportData(),"Userstyle")},a.cancelChanges=function(){var a=this;this.fullscreen&&this.exitFullScreen(),window.setTimeout(function(){a.finishEditing(),window.externalEditor.cancelOpenFiles(),a.active=!1},this.fullscreen?500:0)},a.saveChanges=function(){this.finishEditing(),window.externalEditor.cancelOpenFiles(),this.active=!1},a.popInRibbons=function(){var a,b=window.app.$.editorCurrentScriptTitle;window.app.storageLocal.shrinkTitleRibbon?(window.doc.editorTitleRibbon.style.fontSize="40%",b.style.padding="0",a="-18px"):a="-51px",b.style.display="flex",b.style.marginTop=a;var c=[{marginTop:a},{marginTop:0}],d=window.app.storageLocal.hideToolsRibbon?"-200px":"0";b.style.marginLeft="-200px",c[0].marginLeft="-200px",c[1].marginLeft=0,setTimeout(function(){window.doc.editorToolsRibbonContainer.style.display="flex",window.doc.editorToolsRibbonContainer.animate([{marginLeft:"-200px"},{marginLeft:d}],{duration:500,easing:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"}).onfinish=function(){window.doc.editorToolsRibbonContainer.style.marginLeft=d,window.doc.editorToolsRibbonContainer.classList.add("visible")}},200),setTimeout(function(){window.doc.dummy.style.height="0",$(window.doc.dummy).animate({height:"50px"},{duration:500,easing:$.bez([.215,.61,.355,1]),step:function(a){window.doc.fullscreenEditorHorizontal.style.height="calc(100vh - "+a+"px)"}}),b.animate(c,{duration:500,easing:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"}).onfinish=function(){b.style.marginTop="0",void 0!==c[0].marginLeft&&(b.style.marginLeft="0")}},200)},a.popOutRibbons=function(){var a=window.app.$.editorCurrentScriptTitle,b=window.app.$.editorToolsRibbonContainer,c=!window.app.storageLocal.hideToolsRibbon&&b&&b.classList.contains("visible"),d=a.getBoundingClientRect().height>20,e=[{marginTop:0,marginLeft:0},{marginTop:d?"-51px":"-18px",marginLeft:c?"-200px":0}];c?(a.animate(e,{duration:800,easing:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"}).onfinish=function(){a.style.marginTop=e[1].marginTop+"",a.style.marginLeft=e[1].marginLeft+""},b.animate([{marginLeft:0},{marginLeft:"-200px"}],{duration:800,easing:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"}).onfinish=function(){a.style.display="none",b.style.display="none",b.style.marginLeft="-200px"}):(window.doc.dummy.style.height=d?"50px":"18px",$(window.doc.dummy).animate({height:0},{duration:800,easing:$.bez([.215,.61,.355,1]),step:function(a){window.doc.fullscreenEditorHorizontal.style.height="calc(100vh - "+a+"px)"}}),a.animate([{marginTop:0},{marginTop:d?"-51px":"-18px"}],{duration:800,easing:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"}).onfinish=function(){a.style.display="none",b.style.display="none",a.style.marginTop=d?"-51px":"-18px"})},a.enterFullScreen=function(){var a=this;if(!this.fullscreen){this.fullscreen=!0;var b=this.editor.display.wrapper.getBoundingClientRect(),c=window.doc.fullscreenEditor,d=c.style;d.marginLeft=this.preFullscreenEditorDimensions.marginLeft=b.left+"px",d.marginTop=this.preFullscreenEditorDimensions.marginTop=b.top+"px",d.height=this.preFullscreenEditorDimensions.height=b.height+"px",d.width=this.preFullscreenEditorDimensions.width=b.width+"px",this.fullscreenEl.children[0].innerHTML='<path d="M10 32h6v6h4V28H10v4zm6-16h-6v4h10V10h-4v6zm12 22h4v-6h6v-4H28v10zm4-22v-6h-4v10h10v-4h-6z"/>';var e=$(this.editor.display.wrapper),f=e.find("#buttonShadow")[0];f.style.position="absolute",f.style.right="-1px",this.editor.display.wrapper.classList.add("fullscreen"),e.appendTo(window.doc.fullscreenEditorHorizontal);var g=$("#horizontalCenterer"),h=g.width()+20,i=g.height();void 0!==window.app.storageLocal.hideToolsRibbon?window.app.storageLocal.hideToolsRibbon?window.doc.showHideToolsRibbonButton.style.transform="rotate(0deg)":window.doc.showHideToolsRibbonButton.style.transform="rotate(180deg)":(chrome.storage.local.set({hideToolsRibbon:!1}),window.app.storageLocal.hideToolsRibbon=!1,window.doc.showHideToolsRibbonButton.style.transform="rotate(0deg)"),void 0!==window.app.storageLocal.shrinkTitleRibbon?window.app.storageLocal.shrinkTitleRibbon?window.doc.shrinkTitleRibbonButton.style.transform="rotate(90deg)":window.doc.shrinkTitleRibbonButton.style.transform="rotate(270deg)":(chrome.storage.local.set({shrinkTitleRibbon:!1}),window.app.storageLocal.shrinkTitleRibbon=!1,window.doc.shrinkTitleRibbonButton.style.transform="rotate(270deg)"),e[0].style.height="auto",document.documentElement.style.overflow="hidden",c.style.display="flex",$(c).animate({width:h,height:i,marginTop:0,marginLeft:0},{duration:500,easing:"easeOutCubic",complete:function(){a.editor.refresh(),a.style.width="100vw",a.style.height="100vh",f.style.position="fixed",window.app.$.fullscreenEditorHorizontal.style.height="100vh",window.colorFunction.func({from:{line:0},to:{line:window.colorFunction.cm.lineCount()}},window.colorFunction.cm),a.popInRibbons()}})}},a.exitFullScreen=function(){if(this.fullscreen){this.fullscreen=!1;var a=this;this.popOutRibbons();var b=$(a.editor.display.wrapper),c=b.find("#buttonShadow");c[0].style.position="absolute",setTimeout(function(){a.editor.display.wrapper.classList.remove("fullscreen");var b=window.doc.fullscreenEditor;a.fullscreenEl.children[0].innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48"><path d="M14 28h-4v10h10v-4h-6v-6zm-4-8h4v-6h6v-4H10v10zm24 14h-6v4h10V28h-4v6zm-6-24v4h6v6h4V10H28z"/></svg>',$(b).animate({width:a.preFullscreenEditorDimensions.width,height:a.preFullscreenEditorDimensions.height,marginTop:a.preFullscreenEditorDimensions.marginTop,marginLeft:a.preFullscreenEditorDimensions.marginLeft},{duration:500,easing:"easeOutCubic",complete:function(){b.style.marginLeft="0",b.style.marginTop="0",b.style.width="0",b.style.height="0",$(a.editor.display.wrapper).appendTo(a.$.editorCont).css({height:a.preFullscreenEditorDimensions.height,marginTop:0,marginLeft:0})}})},800)}},a.showOptions=function(){var a=this;this.optionsShown=!0,this.unchangedEditorSettings=$.extend(!0,{},window.app.settings.editor);var b,c=$(".stylesheet-edit-codeMirror").width(),d=$(".stylesheet-edit-codeMirror").height();b=this.fullscreen?Math.sqrt(25e4+d*d)+100:Math.sqrt(c*c+d*d)+100;var e=-b;b=2*b,this.settingsShadow.parentElement.style.width=c+"",this.settingsShadow.parentElement.style.height=d+"",this.fullscreenEl.style.display="none";var f=-500;$("#editorThemeFontSizeInput")[0].value=window.app.settings.editor.zoom,$(this.settingsShadow).css({width:"50px",height:"50px",borderRadius:"50%",marginTop:"-25px",marginRight:"-25px"}).animate({width:b,height:b,marginTop:e,marginRight:e},{duration:500,easing:"linear",progress:function(b){a.editorOptions.style.marginLeft=f-b.tweens[3].now+"px",a.editorOptions.style.marginTop=-b.tweens[2].now+"px"},complete:function(){if(a.fullscreen){var b=$(".stylesheet-edit-codeMirror #settingsContainer")[0];b.style.overflow="scroll",b.style.overflowX="hidden",b.style.height="calc(100vh - 66px)";var c=$(".stylesheet-edit-codeMirror #bubbleCont")[0];c.style.position="fixed",c.style.zIndex="50"}}})},a.hideOptions=function(){var a=this;this.optionsShown=!1;var b=-500;this.fullscreenEl.style.display="block",$(this.settingsShadow).animate({width:0,height:0,marginTop:0,marginRight:0},{duration:500,easing:"linear",progress:function(c){a.editorOptions.style.marginLeft=b-c.tweens[3].now+"px",a.editorOptions.style.marginTop=-c.tweens[2].now+"px"},complete:function(){var b=window.app.settings.editor.zoom,c=a.unchangedEditorSettings.zoom;if(a.unchangedEditorSettings.zoom=b,JSON.stringify(a.unchangedEditorSettings)!==JSON.stringify(window.app.settings.editor)&&a.reloadEditor(),b!==c&&window.app.updateEditorZoom(),a.fullscreen){var d=$(".stylesheet-edit-codeMirror #settingsContainer")[0];d.style.height="376px",d.style.overflowX="hidden";var e=$(".stylesheet-edit-codeMirror #bubbleCont")[0];e.style.position="absolute",e.style.zIndex="auto"}}})},a.reloadEditor=function(a){if(void 0===a&&(a=!1),this.editor){$(this.editor.display.wrapper).remove(),this.$.editorPlaceholder.style.display="flex",this.$.editorPlaceholder.style.opacity="1",this.$.editorPlaceholder.style.position="absolute";for(var b=[],c=this.editor.doc.lineCount(),d=0;d<c;d++)b.push(this.editor.doc.getLine(d));if("main"===this.editorMode)this.newSettings.value.stylesheet=b.join("\n");else try{this.newSettings.value.options=JSON.parse(this.editor.doc.getValue())}catch(a){this.newSettings.value.options=this.editor.doc.getValue()}}this.editor=null;var e="main"===this.editorMode?this.newSettings.value.stylesheet:JSON.stringify(this.newSettings.value.options);this.fullscreen?this.loadEditor(window.doc.fullscreenEditorHorizontal,e,a):this.loadEditor(this.$.editorCont,e,a)},a.fillEditorOptions=function(a){function b(){setTimeout(function(){window.app.settings.editor.zoom=h.querySelector("input").value,window.app.upload()},0)}function c(){setTimeout(function(){window.app.settings.editor.tabSize=~~g.querySelector("#editorTabSizeInput paper-input-container input").value,window.app.upload()},0)}var d=document.querySelector("#editorOptionsTemplate").content;"white"===window.app.settings.editor.theme?d.querySelector("#editorThemeSettingWhite").classList.add("currentTheme"):d.querySelector("#editorThemeSettingWhite").classList.remove("currentTheme"),"dark"===window.app.settings.editor.theme?d.querySelector("#editorThemeSettingDark").classList.add("currentTheme"):d.querySelector("#editorThemeSettingDark").classList.remove("currentTheme"),d.querySelector("#editorTabSizeInput paper-input-container input").setAttribute("value",window.app.settings.editor.tabSize+"");var e=d.querySelector("#editorTabsOrSpacesCheckbox");window.app.settings.editor.useTabs?e.setAttribute("checked","checked"):e.removeAttribute("checked");var f=document.importNode(d,!0);a.appendChild(f);var g=a;g.querySelector("#editorThemeSettingWhite").addEventListener("click",function(){var a=g.querySelectorAll(".editorThemeSetting");a[0].classList.add("currentTheme"),a[1].classList.remove("currentTheme"),window.app.settings.editor.theme="white",window.app.upload()}),g.querySelector("#editorThemeSettingDark").addEventListener("click",function(){var a=g.querySelectorAll(".editorThemeSetting");a[0].classList.remove("currentTheme"),a[1].classList.add("currentTheme"),window.app.settings.editor.theme="dark",window.app.upload()});var h=g.querySelector("#editorThemeFontSizeInput");h.addEventListener("change",function(){b()}),this._updateZoomEl=b,g.querySelector("#editorTabsOrSpacesCheckbox").addEventListener("click",function(){window.app.settings.editor.useTabs=!window.app.settings.editor.useTabs,window.app.upload()}),g.querySelector("#editorTabSizeInput paper-input-container input").addEventListener("change",function(){c()}),this._updateTabSizeEl=c,g.querySelector("#editorJSLintGlobals").remove(),g.querySelector("#keyBindingsText").remove()},a.cmLoaded=function(a){var b=this;this.editor=a,a.refresh(),a.display.wrapper.classList.remove("script-edit-codeMirror"),a.display.wrapper.classList.add("stylesheet-edit-codeMirror"),a.performLint();var c=null;a.on("changes",function(a,b){c=Date.now()});var d=window.setInterval(function(){b.active?c&&Date.now()-c>1e3&&(a.performLint(),c=null):window.clearInterval(d)},2e3),e={};e[window.app.settings.editor.keyBindings.autocomplete]=function(a){window.app.ternServer.complete(a)},this.editor.setOption("extraKeys",e);var f=document.importNode(document.querySelector("#scriptEditorTemplate").content,!0);a.display.sizer.insertBefore(f,a.display.sizer.children[0]);var g=a.display.sizer;this.settingsShadow=g.querySelector("#settingsShadow"),this.editorOptions=g.querySelector("#editorOptions"),this.fillEditorOptions(this.editorOptions),this.fullscreenEl=g.querySelector("#editorFullScreen"),this.fullscreenEl.addEventListener("click",function(){b.toggleFullScreen.apply(b)}),this.settingsEl=g.querySelector("#editorSettings"),this.settingsEl.addEventListener("click",function(){b.toggleOptions.apply(b)}),"nocursor"===a.getOption("readOnly")&&(a.display.wrapper.style.backgroundColor="rgb(158, 158, 158)");var h=a.display.sizer.querySelector("#buttonShadow");this.fullscreen?(a.display.wrapper.style.height="auto",this.$.editorPlaceholder.style.display="none",h.style.right="-1px",h.style.position="absolute",this.fullscreenEl.children[0].innerHTML='<path d="M10 32h6v6h4V28H10v4zm6-16h-6v4h10V10h-4v6zm12 22h4v-6h6v-4H28v10zm4-22v-6h-4v10h10v-4h-6z"/>'):(this.$.editorPlaceholder.style.height=this.editorHeight+"px",this.$.editorPlaceholder.style.width=this.editorWidth+"px",this.$.editorPlaceholder.style.position="absolute",this.editorPlaceHolderAnimation?this.editorPlaceHolderAnimation.play():(this.editorPlaceHolderAnimation=this.$.editorPlaceholder.animate([{opacity:1},{opacity:0}],{duration:300,easing:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"}),this.editorPlaceHolderAnimation.onfinish=function(){this.effect.target.style.display="none"}))},a.loadEditor=function(a,b,c){void 0===b&&(b=this.item.value.stylesheet),void 0===c&&(c=!1);var d=$(this.$.editorPlaceholder);this.editorHeight=d.height(),this.editorWidth=d.width(),!window.app.settings.editor&&(window.app.settings.editor={useTabs:!0,theme:"dark",zoom:"100",tabSize:4,keyBindings:{autocomplete:window.scriptEdit.keyBindings[0].defaultKey,showType:window.scriptEdit.keyBindings[0].defaultKey,showDocs:window.scriptEdit.keyBindings[1].defaultKey,goToDef:window.scriptEdit.keyBindings[2].defaultKey,jumpBack:window.scriptEdit.keyBindings[3].defaultKey,rename:window.scriptEdit.keyBindings[4].defaultKey,selectName:window.scriptEdit.keyBindings[5].defaultKey}}),this.editor=window.CodeMirror(a,{lineNumbers:!0,mode:"css",value:b||this.item.value.stylesheet,scrollbarStyle:"simple",lineWrapping:!0,foldGutter:!0,readOnly:!!c&&"nocursor",theme:"dark"===window.app.settings.editor.theme?"dark":"default",indentUnit:window.app.settings.editor.tabSize,indentWithTabs:window.app.settings.editor.useTabs,messageStylesheetEdit:!0,extraKeys:{"Ctrl-Space":"autocomplete"},gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"],lint:window.CodeMirror.lint.optionsJSON})},a.init=function(){var a=this;this._init(),this.$.dropdownMenu.init(),this.$.exportMenu.init(),this.$.exportMenu.querySelector("#dropdownSelected").innerHTML="EXPORT AS",this.initDropdown(),document.body.classList.remove("editingScript"),document.body.classList.add("editingStylesheet"),window.stylesheetEdit=this,this.$.editorPlaceholder.style.display="flex",this.$.editorPlaceholder.style.opacity="1",this.editor&&(this.editor.display.wrapper.remove(),this.editor=null),window.app.ternServer=window.app.ternServer||new window.CodeMirror.TernServer({defs:[window.ecma5,window.ecma6,window.browserDefs,window.crmAPIDefs]}),window.externalEditor.init(),window.app.storageLocal.recoverUnsavedData&&(chrome.storage.local.set({editing:{val:this.item.value.stylesheet,id:this.item.id,crmType:window.app.crmType}}),this.savingInterval=window.setInterval(function(){if(a.active&&a.editor){var b=void 0;try{b=a.editor.getValue(),chrome.storage.local.set({editing:{val:b,id:a.item.id,crmType:window.app.crmType}})}catch(a){}}else chrome.storage.local.set({editing:!1}),window.clearInterval(a.savingInterval)},5e3)),this.active=!0,setTimeout(function(){a.loadEditor(a.$.editorCont)},750)},a.changeTabEvent=function(a){var b=window.app.util.findElementWithClassName(a.path,"editorTab"),c=b.classList.contains("mainEditorTab");if(c&&"main"!==this.editorMode){b.classList.remove("optionsEditorTab");try{this.newSettings.value.options=JSON.parse(this.editor.getValue())}catch(a){this.newSettings.value.options=this.editor.getValue()}this.hideCodeOptions(),this.editorMode="main"}else c||"main"!==this.editorMode||(b.classList.add("optionsEditorTab"),this.newSettings.value.stylesheet=this.editor.getValue(),this.showCodeOptions(),this.editorMode="options");Array.prototype.slice.apply(document.querySelectorAll(".editorTab")).forEach(function(a){a.classList.remove("active")}),b.classList.add("active")},a}();STE.is="stylesheet-edit",STE.behaviors=[Polymer.NodeEditBehavior,Polymer.CodeEditBehavior],STE.properties=stylesheetEditProperties,Polymer(STE);