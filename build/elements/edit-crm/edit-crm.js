/*
 * Original can be found at https://github.com/SanderRonde/CustomRightClickMenu 
 * This code may only be used under the MIT style license found in the LICENSE.txt file 
**/
"use strict";var editCrmProperties={crm:{type:Array,value:[],notify:!0},crmLoading:{type:Boolean,value:!1,notify:!0},crmEmpty:{type:Boolean,value:!0,notify:!0,computed:"_isCrmEmpty(crm, crmLoading)"},isSelecting:{type:Boolean,value:!1,notify:!0},isAdding:{type:Boolean,value:!1,notify:!0}},EC=function(){function a(){}return a._isColumnEmpty=function(a){return 0===a.list.length&&!this.isAdding},a._isCrmEmpty=function(a,b){return!b&&0===a.length},a._getAriaLabel=function(a){return'Edit item "'+a.name+'"'},a.getColumns=function(){return this.columns&&document.contains(this.columns[0])?this.columns:this.columns=Array.prototype.slice.apply(this.$.mainCont.children).filter(function(a){return a.classList.contains("CRMEditColumnCont")}).map(function(a){return a.querySelector(".CRMEditColumn")})},a.getLastMenu=function(a,b,c){var d=-1,e=-1;return a&&(a.forEach(function(a,f){("menu"===a.type||window.app.shadowStart&&a.menuVal)&&!b[a.id]&&(a.children=a.children||[],void 0!==c&&f===c||(d=f,a.children.length>0&&(e=f)))}),e!==-1)?e:d},a.isNodeVisible=function(a,b,c){var d;if(b.children&&b.children.length>0){d=b.children.length;for(var e=0;e<d;e++)this.isNodeVisible(a,b.children[e],c)}return b.onContentTypes[c]?1:(a[b.id]=!0,0)},a.getIndent=function(a,b,c){var d,e=a.length-1,f=b;for(d=0;d<e;d++)c[a[d].id]&&f--;return f},a.buildCRMEditObj=function(a,b){for(var c,d,e,f=[],g=0,h=-2,i=0,j=[],k=[],l=window.app.settings.crm,m=a.length,n=window.app.crmType,o={},p=0,q=0;q<l.length;q++)p+=this.isNodeVisible(o,l[q],n);if(p||this.isAdding)for(;h!==-1;){h=m>g&&a[g]!==-1&&!o[l[a[g]].id]?a[g]:this.getLastMenu(l,o,b[g]),k[g]=h,d=this.getIndent(l,h,o);var r=[];if(r[i-1]=void 0,c={indent:r,menuPath:f.concat(h),list:l,index:g,shadow:window.app.shadowStart&&window.app.shadowStart<=g},l.forEach(function(a){a.expanded=!1}),h!==-1){i+=d;var s=l[h];s.expanded=!0,l=window.app.shadowStart&&s.menuVal?s.menuVal:l[h].children}c.list.map(function(a,b){return a.path=[],f.forEach(function(b,c){a.path[c]=b}),a.index=b,a.isPossibleAddLocation=!1,a.path.push(b),a}),e=c.list.filter(function(a){return!o[a.id]}),c.list=e,f.push(h),j.push(c),g++}return this.columns=null,{crm:j,setMenus:k}},a.setColumnContOffset=function(a,b,c){void 0===c&&(c=!1),void 0===a.offset&&(a.offset=0),c?a.offset=b:a.offset+=b,a.style.transform="translateY("+a.offset+"px)"},a.moveFollowingColumns=function(a,b){for(var c=window.app.editCRM.querySelectorAll(".CRMEditColumnCont"),d=a.index+1;d<c.length;d++)this.setColumnContOffset(c[d],b)},a.createSorter=function(){var a=this;this.sortables=this.sortables.filter(function(a){return a.destroy(),!1}),this.getColumns().forEach(function(b,c,d){var e=null,f=null,g=0,h=!1;a.sortables.push(new Sortable(b,{group:"crm",animation:50,handle:".dragger",ghostClass:"draggingCRMItem",chosenClass:"draggingFiller",scroll:!0,onChoose:function(a){var g=a.item;if(e=g,f=g,"menu"===g.item.type&&g.expanded){g.expanded=!1,g.querySelector(".menuArrow").removeAttribute("expanded");for(var h=c+1;h<d.length;h++)d[h].style.display="none"}g.currentColumn=b},onEnd:function(a){var c=a.item.parentNode.index,e=a.newIndex;window.app.crm.move(a.item.item.path,window.app.editCRM.setMenus.slice(0,c).concat(e),d[c]===b)},onMove:function(b){a.async(function(){if(b.to!==b.dragged.currentColumn){var c=window.app.editCRM.querySelectorAll(".CRMEditColumnCont"),d=Math.min(b.dragged.currentColumn.index,b.to.index);a.setColumnContOffset(c[d],0,!0);for(var i=d;i<c.length-1;i++){var j=c[i],k=Array.prototype.slice.apply(j.querySelectorAll("edit-crm-item")).filter(function(a){return a!==b.dragged&&a.item&&"menu"===a.item.type&&a.expanded})[0];if(!k)break;var l=Array.prototype.slice.apply(k.parentElement.children).indexOf(k)+window.app.editCRM.crm[i].indent.length+j.offset,m=window.app.editCRM.crm[i+1].indent.length;a.setColumnContOffset(c[i+1],50*(l-m),!0)}}else"menu"===b.related.item.type&&b.related.expanded&&(b.relatedRect.top<b.draggedRect.top?1===g&&h||(a.moveFollowingColumns(b.to,50),h=!0):a.moveFollowingColumns(b.to,-50));e.currentColumn=b.to,f=b.related,g++},10)}}))})},a.build=function(a){function b(){var a=this;this.crm=i,this.notifyPath("crm",this.crm),this.currentTimeout=null,setTimeout(function(){a.crmLoading=!1;for(var b=document.getElementsByTagName("edit-crm-item"),c=0;c<b.length;c++)b[c].update&&b[c].update();setTimeout(function(){window.app.pageDemo.create(),a.createSorter()},0)},50)}void 0===a&&(a={setItems:[],unsetItems:[],quick:!1,superquick:!1});var c=a.setItems,d=a.unsetItems,e=a.quick,f=a.superquick;c=c||[],d=d||[],e=e||!1,f=f||!1;var g=this.buildCRMEditObj(c,d);this.setMenus=g.setMenus;var h,i=g.crm,j=0;return i.forEach(function(a){h=a.indent.length+a.list.length,h>j&&(j=h)}),this.$.mainCont.style.minHeight=50*j+"px",this.crm=[],null!==this.currentTimeout&&window.clearTimeout(this.currentTimeout),this.crmLoading=!0,this.columns=null,f?b.apply(this):this.currentTimeout=window.setTimeout(b.bind(this),e?150:1e3),i},a.ready=function(){var a=this;window.app.editCRM=this,window.app.addEventListener("crmTypeChanged",function(){a._typeChanged()}),this._typeChanged(!0)},a.addToPosition=function(a){var b=window.app.util.findElementWithClassName(a.path,"addingItemPlaceholder");this.addItem(JSON.parse(b.getAttribute("data-path"))),this.isAdding=!1},a.cancelAdding=function(){this.isAdding&&(this.isAdding=!1,this.build({setItems:this.setItems,superquick:!0}))},a.toggleAddState=function(){this.isAdding?this.cancelAdding():(this.isSelecting&&this.cancelSelecting(),this.isAdding=!0,this.build({setItems:this.setItems,superquick:!0}))},a.addItem=function(a){var b=window.app.templates.getDefaultLinkNode({id:window.app.generateItemId()}),c=window.app.crm.lookup(a,!0);c.push(b),window.app.editCRM.build({setItems:window.app.editCRM.setMenus,superquick:!0}),window.app.upload()},a.getSelected=function(){var a,b=[],c=document.getElementsByTagName("edit-crm-item");for(a=0;a<c.length;a++)c[a].classList.contains("highlighted")&&b.push(c[a].item.id);return b},a.ifDefSet=function(a,b){for(var c=[],d=2;d<arguments.length;d++)c[d-2]=arguments[d];for(var e=0;e<c.length;e++){var f=c[e];void 0!==a[f]&&(b[f]=a[f])}},a.makeNodeSafe=function(a){var b={};if(this.ifDefSet(a,b,"type","name","value","linkVal","menuVal","nodeInfo","triggers","scriptVal","stylesheetVal","onContentTypes","showOnSpecified"),a.children){b.children=[];for(var c=0;c<a.children.length;c++)b.children[c]=this.makeNodeSafe(a.children[c])}return b},a.extractUniqueChildren=function(a,b,c){if(b.indexOf(a.id)>-1)c.push(a);else for(var d=0;a.children&&d<a.children.length;d++)this.extractUniqueChildren(a.children[d],b,c)},a.changeAuthor=function(a,b){if("local"!==a.nodeInfo.source){a.nodeInfo.source.author=b;for(var c=0;a.children&&c<a.children.length;c++)this.changeAuthor(a.children[c],b)}},a.crmExportNameChange=function(a,b){return b&&a.nodeInfo&&a.nodeInfo.source&&"local"!==a.nodeInfo.source&&(a.nodeInfo.source.author=b),JSON.stringify(a)},a.getMetaIndexes=function(a){for(var b=-1,c=-1,d=a.split("\n"),e=0;e<d.length;e++)if(b!==-1){if(d[e].indexOf("==/UserScript==")>-1){c=e;break}}else d[e].indexOf("==UserScript==")>-1&&(b=e);return{start:b,end:c}},a.getMetaLines=function(a){var b=this.getMetaIndexes(a);if(b.start===-1)return null;var c=b.start,d=b.end,e=c+1,f=a.split("\n"),g=f.splice(e,d-e);return g},a.getMetaTags=function(a){for(var b,c=this.getMetaLines(a),d={},e=new RegExp(/@(\w+)(\s+)(.+)/),f=0;f<c.length;f++)b=c[f].match(e),b&&(d[b[1]]=d[b[1]]||[],d[b[1]].push(b[3]));return d},a.setMetaTagIfSet=function(a,b,c,d){d&&d[c]&&(Array.isArray(d[c])?a[b]=d[c]:a[b]=[d[c]])},a.getUserscriptString=function(a,b){var c,d="script"===a.type?a.value.script:a.value.stylesheet,e=d.split("\n"),f=this.getMetaIndexes(d),g={};f.start!==-1&&(e.splice(f.start,f.end-f.start+1),g=this.getMetaTags(d)),this.setMetaTagIfSet(g,"name","name",a),b=g.nodeInfo&&JSON.parse(g.nodeInfo[0]).author||b||"anonymous";var h=[];Array.isArray(b)||(h=[b]),g.author=h,"local"!==a.nodeInfo.source&&this.setMetaTagIfSet(g,"downloadURL","url",a.nodeInfo.source),this.setMetaTagIfSet(g,"version","version",a.nodeInfo),g.CRM_contentTypes=[JSON.stringify(a.onContentTypes)],this.setMetaTagIfSet(g,"grant","permissions",a);var i=[],j=[];for(c=0;c<a.triggers.length;c++)a.triggers[c].not?j.push(a.triggers[c].url):i.push(a.triggers[c].url);if(g.match=i,g.exclude=j,this.setMetaTagIfSet(g,"CRM_launchMode","launchMode",a.value),"script"===a.type&&a.value.libraries)for(g.require=[],c=0;c<a.value.libraries.length;c++)a.value.libraries[c].url&&g.require.push(a.value.libraries[c].url);if("stylesheet"===a.type){g.CRM_stylesheet=["true"],this.setMetaTagIfSet(g,"CRM_toggle","toggle",a.value),this.setMetaTagIfSet(g,"CRM_defaultOn","defaultOn",a.value);var k=e.join("\n");e=["GM_addStyle('"+k.replace(/\n/g,"\\n' + \n'")+"');"]}var l=[];for(var m in g)if(g.hasOwnProperty(m))for(c=0;c<g[m].length;c++)l.push("// @"+m+"\t"+g[m][c]);var n="// ==UserScript==\n"+l.join("\n")+"\n// ==/UserScript\n"+e.join("\n");return n},a.generateDocumentRule=function(a){for(var b,c,d=a.triggers.map(function(a){if(a.url.indexOf("*")===-1)return"url("+a+")";var b=a.url.split("://"),c=b[0],d=b.slice(1).join("://"),e=d.split("/"),f=e[0],g=e.slice(1).join("/"),h=c.indexOf("*")>-1,i=f.indexOf("*")>-1,j=g.indexOf("*")>-1;return~~h+~~i+~~j>1||i||h?'regexp("'+a.url.replace(/\*/,".*").replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")+'")':"url-prefix("+c+"://"+f+")"}),e=a.value.stylesheet.split("\n"),f=0;f<e.length;f++)if(b=/(\s+)(\w+)/.exec(e[f])){c=b[1];break}return c=c||"\t","@-moz-document "+d.join(", ")+" {"+e.map(function(a){return c+a}).join("\n")+"}"},a.getExportString=function(a,b,c){switch(b){case"Userscript":return this.getUserscriptString(a,c);case"Userstyle":return 0===a.value.launchMode||1===a.value.launchMode?a.value.stylesheet:this.generateDocumentRule(a);default:case"CRM":return this.crmExportNameChange(a,c)}},a.exportSingleNode=function(a,b){var c=this,d=$("#exportJSONData")[0];d.value=this.getExportString(a,b,null),$("#exportAuthorName")[0].value=a.nodeInfo&&a.nodeInfo.source&&a.nodeInfo.source&&"local"!==a.nodeInfo.source&&a.nodeInfo.source.author||"anonymous",$("#exportAuthorName").on("keydown",function(){var e=this;window.setTimeout(function(){var f=e.value;chrome.storage.local.set({authorName:f});var g;g=c.getExportString(a,b,f),d.value=g},0)}),$("#exportDialog")[0].open(),setTimeout(function(){d.focus(),d.select()},150)},a.exportGivenNodes=function(a){function b(a){var b=a.target.value;chrome.storage.local.set({authorName:b});for(var e=0;e<d.length;e++)c.changeAuthor(d[e],b);var f=JSON.stringify({crm:d});g.value=f}for(var c=this,d=[],e=0;e<a.length;e++)d[e]=this.makeNodeSafe(a[e]);var f={crm:d},g=$("#exportJSONData")[0];$("#exportAuthorName").on("change",b),g.value=JSON.stringify(f),$("#exportDialog")[0].open(),setTimeout(function(){g.focus(),g.select()},150),window.app.storageLocal.authorName&&b({target:{value:window.app.storageLocal.authorName}})},a.exportGivenNodeIDs=function(a){for(var b=[],c=0;c<window.app.settings.crm.length;c++)this.extractUniqueChildren(window.app.settings.crm[c],a,b);this.exportGivenNodes(b)},a.exportSelected=function(){var a=this.getSelected();this.exportGivenNodeIDs(a)},a.cancelSelecting=function(){for(var a=this,b=document.getElementsByTagName("edit-crm-item"),c=0;c<b.length;c++)b[c].classList.remove("selecting"),b[c].classList.remove("highlighted");setTimeout(function(){a.isSelecting=!1},150)},a.removeSelected=function(){for(var a,b,c=this.getSelected(),d=0;d<c.length;d++)if(b=window.app.crm.lookupId(c[d],!0))for(a=0;a<b.length;a++)b[a].id===c[d]&&b.splice(a,1);window.app.upload(),this.build({quick:!0}),this.isSelecting=!1},a.selectItems=function(){for(var a=this,b=document.getElementsByTagName("edit-crm-item"),c=0;c<b.length;c++)b[c].classList.add("selecting");setTimeout(function(){a.isSelecting=!0},150)},a.getCRMElementFromPath=function(a,b){void 0===b&&(b=!1);var c;for(c=0;c<a.length-1;c++)if(this.setMenus[c]!==a[c]){if(b){this.build({setItems:a,superquick:!0});break}return null}var d=this.$.mainCont.children,e=d[a.length+1].children;for(c=0;c<e.length;c++)if("PAPER-MATERIAL"===e[c].tagName){e=e[c].children[0].children;break}for(c=0;c<e.length;c++)if(window.app.util.compareArray(e[c].item.path,a))return e[c];return null},a._typeChanged=function(a){void 0===a&&(a=!1);for(var b=0;b<6;b++)window.app.editCRM.classList[b===window.app.crmType?"add":"remove"](window.app.pageDemo.getCrmTypeFromNumber(b));window.runOrAddAsCallback(window.app.editCRM.build,window.app.editCRM,[{quick:a}])},a}();EC.is="edit-crm",EC.currentTimeout=null,EC.setMenus=[],EC.selectedElements=[],EC.columns=[],EC.sortables=[],EC.properties=editCrmProperties,EC.listeners={crmTypeChanged:"_typeChanged"},Polymer(EC);